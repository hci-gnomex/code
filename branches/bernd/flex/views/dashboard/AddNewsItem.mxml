<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" 
				showCloseButton="true" close="{PopUpManager.removePopUp(this)}"
				layout="vertical" horizontalAlign="right" verticalGap="10"  creationPolicy="all" 
				title="News Item Manager - New Item" styleName="loginWindow"
				borderThickness="4"  titleStyleName="loginTitleStyle" height="725" width="725">	

    <mx:HTTPService 
	    id="saveNewsItem"	 
		destination="saveNewsItem"
	    url="SaveNewsItem.gx"
	    resultFormat="e4x"
	    result="onSaveNewsItem(event)"
	    fault="parentApplication.onFailHttpRequest('Save Newsitem Failed', event)"
	    showBusyCursor="true"
	    useProxy="false">
    </mx:HTTPService> 	

    <mx:Script>            
        <![CDATA[
			import mx.collections.Sort;
			import mx.collections.XMLListCollection;
			import mx.controls.Alert;
			import mx.core.Application;
			import mx.events.CloseEvent;
			import mx.events.ListEvent;
			import mx.events.ValidationResultEvent;
			import mx.managers.CursorManager;
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.utils.ArrayUtil;

			[Bindable]
			public var CFS:String; // CoreFacilitySender
			
			[Bindable]
			public var CFT:String; // CoreFacilityTarget
			
			[Bindable]
			public var itemTitle:String; // Title
			
			[Bindable]
			public var message:String; // Message
			
			[Bindable]
			public var date:Date; // Date
			
			[Bindable]
			public var idNewsItem:int;
			
			[Bindable]
			public var idAppUser:int; // User ID 
			
			public function init():void {
				if(coreFacilities.length < 2){
					CFT = coreFacilities.getItemAt(0).@idCoreFacility;
				}else{
					CFT = cfSelector.selectedItem.@idCoreFacility;
				}
			}
			
			private function save():void {
				if(messageInput.length >= 2000 && titleInput.length >= 200){
					Alert.show("Length of the news item title and message cannot exceed 2000 characters.");
					return;
				}else{
					if(coreFacilities.length < 2){
						CFT = coreFacilities.getItemAt(0).@idCoreFacility;
					}else{
						CFT = cfSelector.selectedItem.@idCoreFacility;
					}
					
					var params:Object = new Object();
					params.idNewsItem = idNewsItem;
					params.title = titleInput.text;
					params.message = messageInput.text;
					params.idAppUser = parentApplication.getIdAppUser();
					params.CFT = CFT;
					params.CFS = "1";
					saveNewsItem.send(params);
					PopUpManager.removePopUp(this);
				}
			}
			
			protected function corefacilityFilter_changeHandler(event:ListEvent):void
			{
				CFT = cfSelector.selectedItem.@idCoreFacility; 
			}
			
			private function onSaveNewsItem(event:ResultEvent):void {
				if (saveNewsItem.lastResult.name() == "SUCCESS") {
					// Success.
				}else{
					Alert.show("Error in saving newsitem.");
				}
			}
			
			private function cancelNewsItem():void{
				PopUpManager.removePopUp(this);
			}
		]]>
    </mx:Script>   
	<mx:XMLListCollection id="coreFacilities" source="{parentApplication.coreFacilitiesICanManage}" />
	
	<mx:VBox styleName="form" width="90%" height="100%" paddingBottom="20" paddingLeft="20" paddingRight="20" paddingTop="20">
		<mx:HBox>
	  		<mx:Label fontWeight="bold" text="Title: "/>
	  		<mx:TextInput id="titleInput" text="{itemTitle}" width="633" />
		</mx:HBox>
		<mx:HBox>
			<mx:Label fontWeight="bold" text="Recipient Core Facility: "/>
			<mx:ComboBox id="cfSelector" change="corefacilityFilter_changeHandler(event)" labelField="@display" visible="{coreFacilities.length >= 2 ? true : false}" includeInLayout="{coreFacilities.length >= 2 ? true : false}" selectedIndex="1" /> 
			<mx:Label id="soloCFLabel"  text="{coreFacilities.getItemAt(0).@display}" visible="{coreFacilities.length &lt; 2 ? true : false}"  includeInLayout="{coreFacilities.length &lt; 2 ? true : false}" />
		</mx:HBox>

		<mx:Label fontWeight="bold" text="Message: "/>
		<mx:TextArea id="messageInput" text="{message}" width="100%" height="535"/>
		
		<mx:HBox width="100%">
			<mx:Button id="cancelButton" label="Cancel" click="cancelNewsItem()" />
			<mx:Spacer width="100%"/>
			<mx:Button label="Save" id="saveButton" click="save()" icon="@Embed(source='../../assets/save.png')" enabled="{titleInput.text != '' &amp;&amp; messageInput.text != ''}" disabledIcon="@Embed(source='../../assets/save_disable.png')"/>
		</mx:HBox>
	</mx:VBox>
</mx:TitleWindow>
