<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" xmlns:views="views.*">


   <mx:HTTPService  
    id="getRequest" 
    url="http://localhost/gnomex/GetRequest.gx"
    destination="getRequest"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetRequest(event)"
    method="POST"
    useProxy="false">
  </mx:HTTPService>
  
 <mx:Script>
 	<![CDATA[
 	
 	import mx.rpc.events.ResultEvent;

	
 	[Bindable]
    private var rowCountMessage:String = new String();
    
    [Bindable]
    public var selectedExperiment:Object;
    
    private var selectedIdRequest:Object;

    public function setResultsCount():void {
    	rowCountMessage = parentDocument.browseTree.selectedItem..Request.length() + " experiments.";
    }
    
    private function getFullName(item:Object, col:int):String {
    	return item.@ownerLastName + ", " + item.@ownerFirstName;
    }
    
    private function getRequestKind(item:Object, col:int):String {
    	var de:XMLList = parentApplication.manageDictionaries.lastResult.Dictionary.(@className == 'hci.gnomex.model.RequestCategory').DictionaryEntry.(@value == item.@codeRequestCategory);
    	if (de.length() == 1) {
	    	return de[0].@display;
    	} else {
    		return "";
    	}
    }
    private function getExperimentKind(item:Object, col:int):String {
    	if (item.@codeMicroarrayCategory == "") {
    		return getRequestKind(item, col);
    	} else {
	    	var de:XMLList = parentApplication.manageDictionaries.lastResult.Dictionary.(@className == 'hci.gnomex.model.MicroarrayCategory').DictionaryEntry.(@value == item.@codeMicroarrayCategory);
	    	if (de.length() == 1) {
		    	return de[0].@display;    		
	    	} else {
	    		return getRequestKind(item, col);
	    	}
    		
    	}
    }
    
    private function getGridRowNumber(item:Object,col:int):String
    {
       var x:int = browseList.getItemIndex(item) + 1;
       return String(x);
    } 
    
	public function expandAllNodes():void
  	{
  		experimentTree.openItems = parentDocument.browseTree.selectedItem;
  		experimentTree.openItems = parentDocument.browseTree.selectedItem..Lab;
  		experimentTree.openItems = parentDocument.browseTree.selectedItem..Project;
  		experimentTree.validateNow();
  		treeContainer.validateNow();
  	}
  	
  	private function collapsAllNodes():void {
  		experimentTree.openItems = [];
  	}
  	
  	private function onExperimentRowSelected():void {
		selectedIdRequest = experimentList.selectedItem.@idRequest;
		
		var parms:Object = new Object();
		parms.idRequest = selectedIdRequest;
		getRequest.send(parms);
  	}

  	private function onExperimentNodeSelected():void {
  		if (experimentTree.selectedItem.name() == 'Request') {
			selectedIdRequest = experimentTree.selectedItem.@idRequest;
			
			var parms:Object = new Object();
			parms.idRequest = selectedIdRequest;
			getRequest.send(parms);
  		}
  	}
  	
  	private function onGetRequest(event:ResultEvent):void {
		selectedExperiment = getRequest.lastResult.Request.(@idRequest == selectedIdRequest);
	    theDetailViews.visible = true;
	    theDetailViews.selectedIndex = 1;
	    theDetailViews.percentHeight = 100;
	    detailView.validateNow();
	    
	    
	}
   public function getTreeIcon(item:Object):Class {
				if (item.name() == "Lab") {
					return parentApplication.iconGroup;
				} else if (item.name() == "Project") {
					return parentApplication.iconProject;
				} else if (item.name() == "RequestCategory") {
					return parentApplication.iconCategory;
				} else if (item.name() == "Request" &&
				           item.@codeRequestCategory == "QC") {
					return parentApplication.iconQC;
				}else {
					return parentApplication.iconExperiment;
				}	
	}   

 	]]>
 </mx:Script>
 
    <mx:XMLListCollection id="browseList" source="{parentDocument.getProjectRequestList.lastResult..Request}"/>
    <mx:VDividedBox width="100%" height="100%" verticalGap="30" dividerColor="#004080" borderStyle="inset">
		<mx:VBox width="100%" height="100%" paddingLeft="8" paddingRight="4" paddingTop="8" paddingBottom="4">
		
		    <mx:HBox width="100%">
				<mx:HBox >
			        <mx:Button icon="@Embed('../assets/application_view_detail.png')" 
			        	label="List" fontFamily="Arial"
			        	click="theViews.selectedIndex = 0" />
			        <mx:Button icon="@Embed('../assets/chart_organisation.png')" 
			        	label="Tree" fontFamily="Arial"
			        	click="theViews.selectedIndex = 1;expandAllNodes()"
			        	/>
			        <mx:Spacer width="50"/>
			        <mx:Button id="downloadButton" label="Show download list"  icon="@Embed('../assets/folder_go.png')" 
			        	toolTip="Show download list on selected items" fontFamily="Arial" 
			        	/>
			    </mx:HBox>
		
				<mx:HBox horizontalAlign="right" width="100%">
				  <mx:Label id="rowCountLabel" width="100%" text="{rowCountMessage}" textAlign="right"/>
				</mx:HBox>
			    	
		    </mx:HBox>
				
				   
		             
		     <mx:ViewStack id="theViews" width="100%" height="100%">
		       <mx:VBox  width="100%" height="100%">
		           <mx:HBox horizontalAlign="right" width="100%">
		           </mx:HBox>
			       <mx:DataGrid  id="experimentList" dataProvider="{parentDocument.browseTree.selectedItem..Request}"  
			       	width="100%" height="100%" fontSize="9" borderColor="#c0c0c0" borderStyle="outset" cornerRadius="4" 
			       	itemClick="onExperimentRowSelected()">
			         <mx:columns>
			            <mx:DataGridColumn headerText=" " 
			            	width="10" 
			            	editable="true"                        	
			            	dataField="@isSelected" 
			            	editorDataField="selected" 
			            	itemRenderer="views.CheckBoxIsSelected">
			            </mx:DataGridColumn>
				       	<mx:DataGridColumn headerText="Group" width="40" dataField="@labName"/>
				        <mx:DataGridColumn headerText="Requester" width="40" labelFunction="getFullName"/>
				       	<mx:DataGridColumn headerText="Project" width="40" dataField="@projectName"/>
				       	<mx:DataGridColumn headerText="Experiment Kind" width="40" labelFunction="getExperimentKind"/>
				       	<mx:DataGridColumn headerText="#" width="30" dataField="@requestNumber"/>
				       	<mx:DataGridColumn headerText="Date" width="42" dataField="@requestCreateDateDisplay"/>
				       	<mx:DataGridColumn headerText="Microarray" width="100" dataField="@slideProductName"/>
			         </mx:columns>
			       </mx:DataGrid> 	       	
		       </mx:VBox>
		       
	
		     	
		     	<mx:VBox  id="treeContainer" width="100%" height="100%">
			       <mx:Tree id="experimentTree" 
			       	dataProvider="{parentDocument.browseTree.selectedItem}" 
			       	width="100%" height="100%" labelField="@label" showRoot="true" 
			       	change="onExperimentNodeSelected()"
			       	 iconFunction="getTreeIcon">	     		
			     	</mx:Tree>
		     		
		       </mx:VBox>
		       
		     	
		     </mx:ViewStack>
		
		     
		</mx:VBox>
		
		<mx:ViewStack id="theDetailViews" width="100%" height="0" visible="true" borderStyle="inset" paddingLeft="10" paddingTop="10" paddingRight="10" paddingBottom="10">
		
			<mx:Canvas width="100%">
			</mx:Canvas>
			
			<views:ExperimentDetailView id="detailView">
			</views:ExperimentDetailView>

			
		</mx:ViewStack>
    	
    </mx:VDividedBox>
	



</mx:Canvas>


