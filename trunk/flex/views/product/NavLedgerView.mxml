<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" xmlns:product="views.product.*" xmlns:renderers="views.renderers.*">
	
	
	<mx:HTTPService 
		id="getProductLedgerList" 
		url="GetProductLedgerList.gx"
		resultFormat="e4x"
		result="onGetProductLedgerList(event)"
		showBusyCursor="true"
		fault="parentApplication.onFailHttpRequest('Unable to get ledger entries', event)"
		method="POST"
		useProxy="false">
	</mx:HTTPService >
	
	<mx:HTTPService 
		id="getProductList" 
		url="GetProductList.gx"
		resultFormat="e4x"
		result="onGetProductList(event)"
		showBusyCursor="true"
		fault="parentApplication.onFailHttpRequest('Unable to get product list entries', event)"
		method="POST"
		useProxy="false">
	</mx:HTTPService >
	
	
	
	<mx:Script> 
		<![CDATA[
			import mx.controls.Alert;
			import mx.rpc.events.ResultEvent;

			
			
			private var selectedIdLab:String;
			private var selectedIdProduct:String;
			
			
			public function init():void{
				getProductLedgerList.send();
				getProductList.send();
				
			}
			
			private function onGetProductLedgerList(event:ResultEvent):void{
				if(getProductLedgerList.lastResult.name() != 'LedgerList'){
					Alert.show( event.result..ERROR.@message.toString(), "Error getting product ledger list" );	
				} else{
					
					for each(var lab:XML in browseTree.dataProvider){
						browseTree.expandItem(lab, true, false);
					}
					
					if(selectedIdLab != null && selectedIdProduct != null){
						reselectTreeItem();
					}
					
				}
				
			}
			
			private function onGetProductList(event:ResultEvent):void{
				if(getProductList.lastResult.name() != 'ProductList'){
					Alert.show( event.result..ERROR.@message.toString(), "Error getting product list" );	
				} else{
					var emptyNode:XML = <Product name="" idProduct="" />
					products.addItemAt(emptyNode, 0);
					productCombo.selectedIndex = -1;
					
					
				}
			}
			
			private function onBrowseTree():void{
				if(browseTree.selectedItem == null){
					return;
				}
				
				if(browseTree.selectedItem.name() == "product"){
					selectedIdLab = browseTree.selectedItem.@idLab;
					selectedIdProduct = browseTree.selectedItem.@idProduct;
					
					productEntryLedgerView.idLab = browseTree.selectedItem.@idLab;
					productEntryLedgerView.idProduct = browseTree.selectedItem.@idProduct;
					productEntryLedgerView.productCount = browseTree.selectedItem.@qty;
					productEntryLedgerView.productName = browseTree.selectedItem.@display;
					productEntryLedgerView.init();
				}
			}
			
			private function reselectTreeItem():void{
				var index:int = 2;
				var found:Boolean = false;
				for each(var lab:XML in browseTree.dataProvider){
					index++;
					if(lab.@idLab == selectedIdLab){
						for each(var product:XML in lab.children()){
							index++;
							if(product.@idProduct == selectedIdProduct){
								browseTree.selectedIndex = index;
								found = true;
								break;
							}
						}	
					}
					
					if(found){
						break;
					}
				}
				
				onBrowseTree();
			}
			
			private function filterLedgerList():void{
				var params:Object = new Object();
			
				if(browseLabCombo.selectedIndex >= 0){
					params.idLab = browseLabCombo.selectedItem.@idLab;
				}
				
				if(productCombo.selectedIndex > 0){
					params.idProduct = productCombo.selectedItem.@idProduct;
				}
				
				getProductLedgerList.send(params);
			}
			
			
		]]>
	</mx:Script> 
	
	
	
	<mx:XMLListCollection id="labs" source="{getProductLedgerList.lastResult..Lab}"/>
	<mx:XMLListCollection id="products" source="{getProductList.lastResult..Product}"/>
	
	
	<mx:VBox id="vbox1" width="100%" height="100%" horizontalAlign="center" verticalGap="2">
		<mx:HBox width="100%" paddingRight="6" paddingTop="8" styleName="panelBox" paddingBottom="4" paddingLeft="6" borderThickness="1" horizontalGap="15">
			<mx:Image source="assets/basket.png"/>
			<mx:Label text="Product Ledgers" styleName="titleLabel" width="124"/>
			
			<mx:Spacer width="17"/>
			<mx:Label text="Lab:"/>
			<renderers:FilterComboBox dataProvider="{parentApplication.labList.source}" 
									  labelField="@name" 
									  prompt="Select a lab..." close="{this.filterLedgerList()}"
									  width="160" 
									  id="browseLabCombo" fontSize="10">
			</renderers:FilterComboBox>
			
			
			<mx:Spacer width="5"/>
			<mx:Label text="Product:"/>
			<mx:ComboBox id="productCombo" dataProvider="{this.products}" labelField="@name" close="{this.filterLedgerList()}" selectedIndex="-1" fontSize="10"/>
		</mx:HBox>
		
		
		<mx:HDividedBox height="100%" width="100%" dividerAlpha="0" dividerThickness="3" dividerAffordance="0">	
			
			<mx:VBox styleName="panelBox" id="navPanel" height="100%" width="270">
				<mx:Tree width="100%" height="100%"  
						 dataProvider="{labs}" 
						 showRoot="false"
						 id="browseTree" click="onBrowseTree();" 
						 doubleClickEnabled="false" 
						 labelField="@display" allowMultipleSelection="false" 
						 iconFunction="parentApplication.getTreeIcon" backgroundAlpha="1" dropShadowEnabled="true" borderStyle="none">
				</mx:Tree>
				
			</mx:VBox>
			
			
			<!-- Box 2 -->
			<mx:VBox height="100%" width="100%">
				<product:ProductLedgerView id="productEntryLedgerView" width="100%" height="100%" />
			</mx:VBox>
			
		</mx:HDividedBox>
	</mx:VBox>
	
</mx:Canvas>
