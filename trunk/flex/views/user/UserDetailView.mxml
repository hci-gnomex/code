<?xml version="1.0" encoding="utf-8"?>
<mx:VBox styleName="panelBox"  xmlns:mx="http://www.adobe.com/2006/mxml"  
	 xmlns:views="views.*" 
	 xmlns:util="views.util.*" 
	 height="100%" width="100%" 
	 label="User Detail"  
	 >
<mx:Label id="titleLabel" styleName="titleLabel" text="{'User ' + parentDocument.fullUser.@displayName}"/>

    <mx:HTTPService 
    id="getAppUser" 
    url="GetAppUser.gx"
    destination="getAppUser"
    showBusyCursor="true"
    resultFormat="e4x"
    result="onGetAppUser(event)"
    fault="parentApplication.onFailHttpRequest('Unable to get user', event)"
    useProxy="false">    
    </mx:HTTPService >
    

    <mx:HTTPService 
    id="saveAppUser" 
    url="SaveAppUser.gx"
    showBusyCursor="true"
    resultFormat="e4x"
    result="onSaveAppUser(event)"
    fault="parentApplication.onFailHttpRequest('Unable to save user', event)"
    useProxy="false">
    <mx:request>
            <idAppUser>{parentDocument.fullUser != null ? parentDocument.fullUser.@idAppUser : "0"}</idAppUser>
            <lastName>{lastName.text}</lastName>
            <firstName>{firstName.text}</firstName>
            <uNID>{uNID.text}</uNID>
            <institute>{institute.text}</institute>
            <department>{department.text}</department>
            <phone>{phone.text}</phone>
            <email>{email.text}</email>
			<ucscUrl>{ucsc.text}</ucscUrl>
            <userNameExternal>{externalUserName.text}</userNameExternal>
            <passwordExternal>{externalUserPassword.text}</passwordExternal>
            <codeUserPermissionKind>{permissionGroup.selectedValue}</codeUserPermissionKind>
            <isActive>{isActive.selected == true ? 'Y' : 'N'}</isActive>
    </mx:request>
    </mx:HTTPService >
    
    <mx:Script>
        <![CDATA[
            import mx.controls.Alert;
            import mx.rpc.events.FaultEvent;
            import mx.rpc.events.ResultEvent;
            import mx.events.CloseEvent;
            
           
            
            private var savedIdAppUser:Object = '';
            
			public function promptToSaveDirty():void {
				if (dirty.isDirty()) {
					Alert.show("Your changes to user " + parentDocument.fullUser.@displayName + " have not been saved.  Save now?", 
								null, 
								(Alert.YES | Alert.NO), this,  
								onPromptToSaveDirty);
				}
			}
			
				
			private function onPromptToSaveDirty(event:CloseEvent):void {
			    if (event.detail==Alert.YES) {
			    	save();
			    } else {
					dirty.resetDirty();
			    }

			}
      
			  
            private function save():void {
				saveAppUser.send();
            }
            
            private function onSaveAppUser(event:ResultEvent):void {
				if (saveAppUser.lastResult.name() == "SUCCESS") {
					savedIdAppUser = saveAppUser.lastResult.@idAppUser;
					var params:Object = new Object();
					params.idAppUser = savedIdAppUser;
		 			dirty.resetDirty();
		 			
		 			var itemToSelect:XML = new XML("<AppUser id='" + savedIdAppUser + "'/>");
	          		parentApplication.navUsersView.itemToSelect = itemToSelect;
    	      		parentApplication.navUsersView.refreshAppUserList();
				} else { 
					if (saveAppUser.lastResult.name() == "ERROR") {
						Alert.show(saveAppUser.lastResult.@message);	
					} else {
						Alert.show("An error occurred while saving the user record.");						
					}

				}

            	
            }
            
            
            private function onGetAppUser(event:ResultEvent):void {
              parentDocument.fullUser = getAppUser.lastResult.AppUser.(@idAppUser = savedIdAppUser);
              this.isActive.selected =  parentDocument.fullUser.@isActive == 'Y' ? true : false;
              
              

            }
            
            private function onUserAccountChange():void {
            	this.dirty.setDirty();
            	if (this.radioUniversityUser.selected) {
            		currentState = "";
            		externalUserName.text = "";
            		this.externalUserPassword.text = "";
            	} else {            		
            		currentState = "externalUserState";
            		uNID.text = "";
            		
            	}
            }
            
        ]]>
    </mx:Script>


    
	<mx:VBox height="100%" width="100%"  styleName="form">
    
    
	<mx:VDividedBox  width="100%" height="100%" paddingLeft="4" paddingRight="4" paddingTop="4" paddingBottom="4">
	
		<mx:VBox  width="100%" verticalGap="10">
			<mx:HBox verticalAlign="bottom">
				<mx:VBox verticalGap="1"  width="100%">
					<mx:Label text="First name"/>
					<mx:TextInput id="firstName" maxChars="200" text="{parentDocument.fullUser.@firstName}" width="170" change="dirty.setDirty()"/>
				</mx:VBox>
				<mx:VBox verticalGap="1" width="100%" id="vbox3">
					<mx:Label text="Last name"/>
					<mx:TextInput id="lastName" maxChars="200" editable="true" enabled="true" text="{parentDocument.fullUser.@lastName}" width="170" change="dirty.setDirty()"/>
				</mx:VBox>
				<mx:VBox verticalGap="1"  width="100%" >
					<mx:Label text="Ucsc Url" id="Label5"/>
					<mx:TextInput id="ucsc" text="{parentDocument.fullUser.@ucscUrl}" width="200" change="dirty.setDirty()"/>
				</mx:VBox>
				<mx:CheckBox id="isActive" label="User is Active"  click="dirty.setDirty()">
				</mx:CheckBox>				

				
			</mx:HBox>
			<mx:HBox verticalAlign="middle">
				<mx:VBox verticalGap="1"   width="100%" >
					<mx:Label text="Institution" id="Label2"/>
					<mx:TextInput width="170" id="institute" text="{parentDocument.fullUser.@institute}" change="dirty.setDirty()"/>
				</mx:VBox>
				<mx:VBox verticalGap="1"   width="100%" >
					<mx:Label text="Department" id="Label1"/>
					<mx:TextInput id="department" text="{parentDocument.fullUser.@department}" width="170" change="dirty.setDirty()"/>
				</mx:VBox>
				<mx:VBox verticalGap="1"  width="100%" >
					<mx:Label text="Email" id="Label"/>
					<mx:TextInput id="email" text="{parentDocument.fullUser.@email}" width="200" change="dirty.setDirty()"/>
				</mx:VBox>
				<mx:VBox verticalGap="1"  width="100%" >
					<mx:Label text="Phone" id="Label0"/>
					<mx:TextInput id="phone" text="{parentDocument.fullUser.@phone}" width="130" change="dirty.setDirty()"/>
				</mx:VBox>
				 
			</mx:HBox>
		  	<mx:HBox width="100%" height="100%">
		  	  <mx:VBox borderStyle="inset" borderColor="#C9D7E1" paddingBottom="4" paddingRight="4" paddingLeft="4" verticalGap="8">
				<mx:HBox verticalGap="0" visible="true" id="radioUnivOrExternalBox">
					<mx:RadioButtonGroup id="radioGroupUserAccount"/>
					<mx:RadioButton label="University user" groupName="radiogroup1" click="{onUserAccountChange()}" value="UNID" id="radioUniversityUser"/>
					<mx:RadioButton label="External user" groupName="radiogroup1" click="{onUserAccountChange()}" value="EXTERNAL" id="radioExternalUser">
					</mx:RadioButton>
					
				</mx:HBox>	
				<mx:HBox paddingLeft="0">	  	      
		  	    <mx:VBox verticalGap="1" id="unidContainer" width="100">
		  	      <mx:Label text="uNID" />
		  	      <mx:TextInput id="uNID" 
		  	      	text="{parentDocument.fullUser.@uNID}" 
		  	       width="100" change="dirty.setDirty()"/>
		  	     </mx:VBox>		  	    	
		  	    <mx:VBox paddingLeft="0" paddingBottom="0" paddingRight="0" paddingTop="0" verticalGap="0" id="permissionKindContainer">
		  	      <mx:Label text="Permission Level"/>
		  	        <mx:HBox verticalGap="0" paddingLeft="10" paddingTop="0">
		  	           <mx:RadioButtonGroup id="permissionGroup" selectedValue="{parentDocument.fullUser.@codeUserPermissionKind}"/>
		  	         <mx:RadioButton label="Group" id="isGroupPermissionLevel" groupName="permissionGroup" click="dirty.setDirty()">
		  	           <mx:value>LAB</mx:value>
		  	         </mx:RadioButton>
		  	          <mx:RadioButton label="Admin" id="isAdminPermissionLevel" groupName="permissionGroup" click="dirty.setDirty()">
		  	           <mx:value>ADMIN</mx:value>
		  	          </mx:RadioButton>
		  	         <mx:RadioButton label="Billing Admin" id="isBillingPermissionLevel" groupName="permissionGroup" click="dirty.setDirty()">
		  	           <mx:value>BILLING</mx:value>
		  	         </mx:RadioButton>		  	         	
		  	        </mx:HBox> 
		  	    </mx:VBox>
				</mx:HBox>		  		
		  	  </mx:VBox>


				
	
		    
		    </mx:HBox>
	
	  </mx:VBox>
	   
		<mx:VBox width="100%" height="100%">
			<mx:HBox width="100%" paddingLeft="4" paddingRight="4" paddingTop="4" paddingBottom="4" height="100%">
			  <mx:DataGrid id="membershipLabs" width="100%" dataProvider="{parentDocument.membershipLabs}" height="100%">
		            <mx:columns>
		                <mx:DataGridColumn dataField="@name" headerText="Labs"/>
		            </mx:columns>
		        </mx:DataGrid>
			    <mx:DataGrid id="collaboratingLabs" width="100%" dataProvider="{parentDocument.collaboratingLabs}" height="100%">
		            <mx:columns>
		                <mx:DataGridColumn dataField="@name" headerText="Collaborating Labs"/>
		            </mx:columns>
		        </mx:DataGrid>
			    <mx:DataGrid id="managingLabs" width="100%" dataProvider="{parentDocument.managingLabs}" height="100%">
		            <mx:columns>
		                <mx:DataGridColumn dataField="@name" headerText="Managing Labs"/>
		            </mx:columns>
		        </mx:DataGrid>
			</mx:HBox>
		</mx:VBox>
	

	</mx:VDividedBox>
	</mx:VBox>

	<mx:ControlBar   width="100%" paddingBottom="4" paddingLeft="4" paddingRight="4" paddingTop="4" verticalAlign="middle" horizontalAlign="left">
	  <mx:HBox width="100%" horizontalAlign="right">
	    <util:DirtyNote id="dirty"/>
	  
		<mx:Button label="Save" click="save()" icon="@Embed('../../assets/action_save.gif')" width="70"/>
	  </mx:HBox>	
	</mx:ControlBar>
  
  <mx:states> 

  	
  	<mx:State name="externalUserState">
  	<mx:AddChild relativeTo="{permissionKindContainer}" position="before">
  		<mx:HBox width="100%" >
		  	     <mx:VBox verticalGap="1"   id="vbox2">
		  	     	<mx:Label text="User name" />
		  	     	<mx:TextInput id="externalUserName" 
		  	     		width="120" text="{parentDocument.fullUser.@userNameExternal}" change="dirty.setDirty()"/>
		  	     </mx:VBox>
		  	     <mx:VBox verticalGap="1"  >
		  	     	<mx:Label text="Password"/>
		  	     	<mx:TextInput id="externalUserPassword" 
		  	     		text="{parentDocument.fullUser.@passwordExternalEntered}" 
		  	     		width="167" displayAsPassword="true"  change="dirty.setDirty()"/>
		  	     </mx:VBox>
		 </mx:HBox>

  	</mx:AddChild>
  	<mx:RemoveChild target="{unidContainer}"/>
  	</mx:State>
  </mx:states>
</mx:VBox>
