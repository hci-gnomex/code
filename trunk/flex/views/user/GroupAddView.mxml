<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" layout="vertical" title="Add Group" width="390" height="110" defaultButton="{saveButton}">
    <mx:HTTPService 
    id="saveLab" 
    url="SaveLab.gx"
    showBusyCursor="true"
    resultFormat="e4x"
    result="onSaveLab(event)"
    fault="parentApplication.onFailHttpRequest('Unable to save group', event)"
    useProxy="false">
    </mx:HTTPService >
    
    <mx:HTTPService 
    id="getLab" 
    url="GetLab.gx"
    destination="getLab"
    showBusyCursor="true"
    resultFormat="e4x"
    result="onGetLab(event)"
    fault="parentApplication.onFailHttpRequest('Unable to get group', event)"
    useProxy="false">    
    </mx:HTTPService >  
	
	<mx:HTTPService 
		id="getLabList" 
		url="GetLabList.gx"
		showBusyCursor="true"
		resultFormat="e4x"
		result="onGetLabList(event)"
		fault="parentApplication.onFailHttpRequest('Failed to get group list', event)"
		destination="getLabList"
		useProxy="false">
	</mx:HTTPService >

<mx:Script>
	<![CDATA[
		import mx.collections.XMLListCollection;
		import mx.controls.Alert;
		import mx.managers.PopUpManager;
		import mx.rpc.events.FaultEvent;
		import mx.rpc.events.ResultEvent;
		
		private var savedIdLab:Object;
		
		public function prepToSave():void
		{
			getLabList.send();
		}
		
		private function onGetLabList(event:ResultEvent):void{
			var notUnique:Boolean = false;
			for(var i:int = 0; i < labs.length; i++)
			{
				var theLab:Object = labs.getItemAt(i);
				
				if(theLab.@lastName.toString().toUpperCase() == lastName.text.toUpperCase() && 
				   theLab.@firstName.toString().toUpperCase() == firstName.text.toUpperCase()){
					notUnique = true;
				}
			}
			
			if(notUnique == true)
			{
				Alert.show("The lab name you selected is already in use.  Please select a different name for your lab", "Lab name already in use");
			}
			else
			{
				save();
			}

		}
		
		
		private function save():void {
			var params:Object = new Object();
			
			params.idLab = 0;
			params.lastName  = lastName.text;
			params.firstName = firstName.text;
			params.isActive = "Y";
			params.isCcsgMember = "N";
			params.isExternal = "N";
			
			params.accountsXMLString = "<billingAccounts/>";
			params.membersXMLString = "<members/>";
			params.collaboratorsXMLString = "<collaborators/>";
			params.managersXMLString = "<managers/>";
			params.institutionsXMLString = "<institutions/>";
			
			saveLab.send(params);
		}
		
		private function onSaveLab(event:ResultEvent):void {
			if (saveLab.lastResult.name() == "SUCCESS") {
				parentApplication.getLabList.send();
				savedIdLab = saveLab.lastResult.@idLab;
				var params:Object = new Object();
				params.idLab = savedIdLab;
	 			getLab.send(params);
				PopUpManager.removePopUp(this);
			} else {
				Alert.show("An error occurred while saving the group.");
			}			
		}
		
		
	     private function onGetLab(event:ResultEvent):void {
          parentApplication.navUsersView.fullLab = getLab.lastResult.Lab.(@idLab = savedIdLab);
          
          var itemToSelect:XML = new XML("<Lab id='" + savedIdLab + "'/>");
          parentApplication.navUsersView.itemToSelect = itemToSelect;

          parentApplication.navUsersView.refreshGroupList();
          parentApplication.navUsersView.labSearchText.text = parentApplication.navUsersView.fullLab.@name;
        }
	]]>
</mx:Script>
	
	<mx:XMLListCollection id="labs" source="{getLabList.lastResult..Lab}"/>
	<mx:HBox width="100%">
		<mx:VBox height="100%" verticalGap="0" width="100%">
			<mx:Label text="Investigator First Name"/>
			<mx:TextInput id="firstName" width="100%"/>
		</mx:VBox>
		<mx:VBox height="100%" verticalGap="0" width="100%">
			<mx:Label text="Investigator Last name (or lab name)"/>
			<mx:TextInput id="lastName" width="100%"/>
		</mx:VBox>
	</mx:HBox>
	<mx:ControlBar horizontalAlign="right">
		<mx:Button label="Save" id="saveButton" click="prepToSave()" icon="@Embed(source='../../assets/save.png')" enabled="{lastName.text != ''}" disabledIcon="@Embed(source='../../assets/save_disable.png')"/>
		<mx:Button label="Cancel" click="{mx.managers.PopUpManager.removePopUp(this)}"/>
	</mx:ControlBar>
	
</mx:TitleWindow>
