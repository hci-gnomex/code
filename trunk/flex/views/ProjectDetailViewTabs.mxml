<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%">

<mx:HTTPService  
    id="saveProject" 
    url="http://localhost/gnomex/SaveProject.gx"
    destination="saveProject"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onSaveProject(event)"
    fault="onSaveProjectFailed(event)"
    method="POST"
    useProxy="false">
</mx:HTTPService>
  
<mx:Script>
	<![CDATA[
		import mx.rpc.events.FaultEvent;
		import mx.rpc.events.ResultEvent;
		import mx.controls.Alert;
		
		public function sortExperimentDesigns(obj1:Object, obj2:Object, fields:Array=null):int {
			if (obj1 == null && obj2 == null) {
				return 0;
			} else if (obj1 == null) {
				return 1;
			} else if (obj2 == null) {
				return -1;
			} else {
				var ed1:String = obj1.@experimentDesign;
				var ed2:String = obj2.@experimentDesign;
				
				if (ed1 == 'Other') {
					return 1;
				} else if (ed2 == 'Other') {
					return  -1;
				} else {
					if (ed1 < ed2) {
						return -1;
					} else if (ed1 > ed2) {
						return 1;
					} else {
						return 0;
					}
				}			
				
			}
		}
		public function sortExperimentFactors(obj1:Object, obj2:Object, fields:Array=null):int {
			if (obj1 == null && obj2 == null) {
				return 0;
			} else if (obj1 == null) {
				return 1;
			} else if (obj2 == null) {
				return -1;
			} else {
				var ef1:String = obj1.@experimentFactor;
				var ef2:String = obj2.@experimentFactor;
				if (ef1 == 'Other') {
					return 1;
				} else if (ef2 == 'Other') {
					return  -1;
				} else  {
					if (ef1 < ef2) {
						return -1;
					} else if (ef1 > ef2) {
						return 1;
					} else {
						return 0;
					}
				}				
				
			}
		}
		
		public function save():void {
			parentDocument.parentDocument.selectedProject.@name = projectName.text;
			parentDocument.parentDocument.selectedProject.@description = projectDescription.text;
			
			if (isVisibleToMembers.selected) {
				parentDocument.parentDocument.selectedProject.@codeVisibility = 'MEM';
			} else if (isVisibleToMembersAndCollaborators.selected) {
				parentDocument.parentDocument.selectedProject.@codeVisibility = 'MEMCOL';
			} else if (isVisibleToPublic.selected) {
				parentDocument.parentDocument.selectedProject.@codeVisibility = 'PUBLIC';
			} 
			
			var params:Object = new Object();
			params.projectXMLString = parentDocument.parentDocument.selectedProject.toXMLString();
			params.parseEntries = 'Y';
			saveProject.send(params);
		}
		
		private function onSaveProject(event:ResultEvent):void {
        	if (saveProject.lastResult.name() == "SUCCESS") {
        		
        	} else {
        		Alert.show(saveProject.lastResult..ACTMESSAGE.@TEXT);
        	}
			
		}
		
		private function onSaveProjectFailed(event:FaultEvent):void {
			Alert.show("failed to save project " + event.message);
		}

	]]>
</mx:Script>

	  
	  <mx:XMLListCollection id="experimentDesignEntries" source="{parentDocument.parentDocument.selectedProject.ExperimentDesignEntries.ExperimentDesignEntry}" 
	  	 sort="{experimentDesignSorter}"/>
	  <mx:Sort id="experimentDesignSorter" compareFunction="sortExperimentDesigns"
	  unique="true"/>
	  
	  <mx:XMLListCollection id="experimentFactorEntries" source="{parentDocument.parentDocument.selectedProject.ExperimentFactorEntries.ExperimentFactorEntry}" 
	  	 sort="{experimentFactorSorter}"/>
	  <mx:Sort id="experimentFactorSorter" compareFunction="sortExperimentFactors"
	  unique="true"/>
 

   <mx:VBox width="100%" height="100%">
		<mx:TabNavigator width="100%" height="100%"  backgroundAlpha=".2" paddingTop="4">
			<mx:Canvas label="Project" width="100%" height="100%" >
				<mx:VBox width="100%" height="100%" verticalGap="20"  paddingLeft="8" paddingRight="8"  paddingTop="8">
				    <mx:VBox width="100%" verticalGap="0">
						<mx:Label text="Project name:"/>
						<mx:TextInput id="projectName" width="100%"  
							text="{parentDocument.parentDocument.selectedProject.@name}"/>			    	
						<mx:Label text="(Suggested naming convention: Lab-Species-Experiment title)"/>
				    </mx:VBox>
					
					<mx:VBox width="100%" verticalGap="0">
						<mx:Label text="Project description:"/>
						<mx:TextArea height="60" id="projectDescription" width="100%" 
							text="{parentDocument.parentDocument.selectedProject.@description}"/>			    	
				    </mx:VBox>
				    
				    <mx:VBox width="100%" verticalGap="0">
						<mx:Label text="Visibility to experiment and data:"/>
						<mx:RadioButton id="isVisibleToMembers" label="Visible to members" groupName="radiogroup1" selected="{parentDocument.parentDocument.selectedProject.@isVisibleToMembers == 'Y'}"/>
						<mx:RadioButton id="isVisibleToMembersAndCollaborators" label="Visible to members and collaborators" groupName="radiogroup1" selected="{parentDocument.parentDocument.selectedProject.@isVisibleToMembersAndCollaborators == 'Y'}"/>
						<mx:RadioButton id="isVisibleToPublic" label="Visible to everyone (available to public)" groupName="radiogroup1" selected="{parentDocument.parentDocument.selectedProject.@isVisibleToPublic == 'Y'}"/>
				    	
				    </mx:VBox>
					
					
				</mx:VBox>
			</mx:Canvas>
			<mx:Canvas label="Experiment Design" width="100%" height="100%">
				<mx:HDividedBox width="100%" height="100%" paddingTop="1" paddingRight="8" paddingLeft="8" paddingBottom="1">
				    <mx:DataGrid width="50%" height="100%" 
				    	dataProvider="{experimentDesignEntries}" 
				    	selectionColor="#FFFFFF" fontSize="9"
 						showHeaders="true" headerHeight="20" variableRowHeight="true">
				        <mx:columns>
				            <mx:DataGridColumn headerText=" " 
				            	width="10" 
				            	editable="true"                        	
				            	dataField="@isSelected" 
				            	editorDataField="selected"
				            	itemRenderer="views.CheckBoxIsSelected" >
				            </mx:DataGridColumn>
				            <mx:DataGridColumn  width="200" headerText="Experiment Design (general intent)" editable="false" editorDataField="selected" dataField="@experimentDesign">
				                <mx:itemRenderer>
				                    <mx:Component >
				                         <mx:HBox>
				                           <mx:Label text="{data.@experimentDesign}">			                           	
				                           </mx:Label>
				                           <mx:TextInput id="edOtherLabel" fontSize="9"
				                           	text="{data.@otherLabel}"
				                           	change="{data.@otherLabel = edOtherLabel.text}" 
				                           	width="{data.@experimentDesign == 'Other' ? 170 : 0}"  
				                           	height="{data.@experimentDesign == 'Other' ? 20 : 0}"  
				                           	visible="{data.@experimentDesign == 'Other' ? true : false}" 
				                           	editable="{data.@experimentDesign == 'Other' ? true : false}">			                           
				                           </mx:TextInput>
				                         	
				                         </mx:HBox>
				                    </mx:Component>
				                </mx:itemRenderer>
			                </mx:DataGridColumn>
			            </mx:columns>
				    </mx:DataGrid>

				    <mx:DataGrid width="50%" height="100%" dataProvider="{experimentFactorEntries}" selectionColor="#FFFFFF" fontSize="9" showHeaders="true" headerHeight="20" variableRowHeight="true">
				        <mx:columns>
				            <mx:DataGridColumn headerText=" " 
				            	width="10" 
				            	editable="true"                        	
				            	dataField="@isSelected" 
				            	editorDataField="selected" 
				            	itemRenderer="views.CheckBoxIsSelected">
				            </mx:DataGridColumn>
				            <mx:DataGridColumn  width="200" headerText="Experimental Factors (differences between samples)" editable="false" editorDataField="selected" dataField="@experimentFactor">
				                <mx:itemRenderer>
				                    <mx:Component >
				                         <mx:HBox>
				                           <mx:Label text="{data.@experimentFactor}">			                           	
				                           </mx:Label>
				                           <mx:TextInput id="efOtherLabel" fontSize="9"
				                           	text="{data.@otherLabel}"
				                           	change="{data.@otherLabel = efOtherLabel.text}" 
				                           	width="{data.@experimentFactor == 'Other' ? 170 : 0}"  
				                           	height="{data.@experimentFactor == 'Other' ? 20 : 0}"  
				                           	visible="{data.@experimentFactor == 'Other' ? true : false}" 
				                           	editable="{data.@experimentFactor == 'Other' ? true : false}">			                           
				                           </mx:TextInput>
				                         	
				                         </mx:HBox>
				                    </mx:Component>
				                </mx:itemRenderer>
			                </mx:DataGridColumn>
				        </mx:columns>
				    </mx:DataGrid>
				</mx:HDividedBox>
			</mx:Canvas>
		</mx:TabNavigator>
       
   </mx:VBox>
   

	
</mx:Canvas>
