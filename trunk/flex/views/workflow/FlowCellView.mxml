<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" 
	layout="vertical" 
	width="100%" height="100%" 
	title="Solexa Flow Cells"
	xmlns:util="views.util.*">
	 
   <mx:HTTPService  
    id="getFlowCellList" 
    url="GetFlowCellList.gx"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetFlowCellList(event)"
	fault="parentApplication.onFailHttpRequest('Failed to get flow cell list', event)"
    method="POST"
    useProxy="false">
  </mx:HTTPService>
      
<mx:Script>
	<![CDATA[
		import mx.controls.dataGridClasses.DataGridColumn;
		import mx.controls.Alert;
		import mx.rpc.events.ResultEvent;
		import hci.flex.renderers.LabelDictionary;

    	private function getLaneRowNumber(item:Object,col:int):String
    	{
       		var x:int = flowCellLanesGrid.dataProvider.getItemIndex(item) + 1;
       		return String(x);

    	} 
    	
        private function onGetFlowCellList(event:ResultEvent):void {
        	if (event.result.name() == "FlowCellList") {
        	} else {
        		Alert.show(event.result..ERROR.@message.toString(), "Error getting flow cell list");
        	} 
        }
		private function showPrintableForm():void {
			var url:URLRequest = new URLRequest('ShowFlowCellForm.gx?idFlowCell=' + this.flowCellsGrid.selectedItem.@idFlowCell);
			navigateToURL(url, '_blank');			
		}
		
		private function getFragmentSizeRange(item:Object, col:DataGridColumn):String {
			return (item.@fragmentSizeFrom != "" ? item.@fragmentSizeFrom : "?") + " - " + 
			       (item.@fragmentSizeTo != "" ? item.@fragmentSizeTo : "?");
		}
		private function getSeqPrepLibFragmentSizeRange(item:Object, col:DataGridColumn):String {
			return (item.@seqPrepQualFragmentSizeFrom != "" ? item.@seqPrepQualFragmentSizeFrom : "?") + " - " + 
			       (item.@seqPrepQualFragmentSizeTo != "" ? item.@seqPrepQualFragmentSizeTo : "?");
		}    	
		private function getOrganism(item:Object, col:DataGridColumn):String {
			return parentApplication.dictionaryManager.getEntryDisplay('hci.gnomex.model.Organism', item.@idOrganism);
		}
		private function getNumberSequencingCycles(item:Object, col:DataGridColumn):String {
			return parentApplication.dictionaryManager.getEntryDisplay('hci.gnomex.model.NumberSequencingCycles', item.@idNumberSequencingCycles);
		}
		private function getFlowCellType(item:Object, col:DataGridColumn):String {
			return parentApplication.dictionaryManager.getEntryDisplay('hci.gnomex.model.FlowCellType', item.@idFlowCellType);
		}
	]]>
</mx:Script>    	
	<mx:XMLListCollection id="flowCells" source="{getFlowCellList.lastResult.FlowCell}"/>
	
	<mx:VDividedBox width="100%" height="100%" styleName="form" paddingBottom="4" paddingLeft="4" paddingRight="4" paddingTop="4">
		<mx:VBox width="100%" height="100%"   verticalGap="0">	
			<mx:VBox width="100%" height="100%" verticalGap="1">			
				<mx:VBox width="100%" height="100%" verticalGap="1">			
					<mx:Label text="Flow Cells" fontWeight="bold"/>
					<mx:DataGrid id="flowCellsGrid" width="100%" height="100%" dataProvider="{flowCells}">
						<mx:columns>
							<mx:DataGridColumn  dataField="@number" headerText="#" width="65"/>
							<mx:DataGridColumn  dataField="@barcode" headerText="Barcode" width="90"/>
							<mx:DataGridColumn  dataField="@idFlowCellType" headerText="Flow Cell Type" width="120"
 	                            itemRenderer="{LabelDictionary.create(parentApplication.dictionaryManager, 'hci.gnomex.model.FlowCellType', '@idFlowCellType')}"/>                 							
							<mx:DataGridColumn  dataField="@notes" headerText="Content" />
						</mx:columns>				
					</mx:DataGrid>		
				</mx:VBox>
			</mx:VBox>
		</mx:VBox>
		<mx:VBox width="100%"  verticalGap="1">
			<mx:HBox width="100%" verticalAlign="middle">
				<mx:Label text="{'Flow Cell ' + flowCellsGrid.selectedItem.@number}"  fontWeight="bold"/>
				<mx:LinkButton label="Printable form" fontStyle="normal" textDecoration="underline" color="#2017D8" click="showPrintableForm()"  enabled="{flowCellsGrid.selectedItem != null}"/>
			</mx:HBox>

			<mx:DataGrid  id="flowCellLanesGrid" dataProvider="{flowCellsGrid.selectedItem.flowCellChannels.FlowCellChannel}" width="100%" height="250" horizontalScrollPolicy="auto">	
				<mx:columns>
					<mx:DataGridColumn  headerText="Channel" dataField="@number" width="55"/>
					<mx:DataGridColumn  dataField="@contentNumber" width="80" headerText="Seq Sample #"/> 
					<mx:DataGridColumn  dataField="@idFlowCellType" headerText="Flow Cell Type" width="100" labelFunction="getFlowCellType"/>                 							
					<mx:DataGridColumn  dataField="@idOrganism" headerText="Organism" width="90" labelFunction="getOrganism"/>                 							
					<mx:DataGridColumn  dataField="@idNumberSequencingCycles" headerText="# Cycles Requested"  width="90" labelFunction="getNumberSequencingCycles">                 							
                       <mx:headerRenderer > 
						    <mx:Component>
						    	<mx:VBox verticalGap="0"   horizontalAlign="center" verticalAlign="middle">
							        <mx:Label text="# Cycles"/>
							        <mx:Label text="(requested)"/>
				    			</mx:VBox>
						    </mx:Component>
						</mx:headerRenderer>
					</mx:DataGridColumn>
					<mx:DataGridColumn   labelFunction="getFragmentSizeRange" width="90" headerText="Est. Fragment Size">
                       <mx:headerRenderer > 
						    <mx:Component>
						    	<mx:VBox verticalGap="0"   horizontalAlign="center" verticalAlign="middle">
							        <mx:Label text="Frag Size"/>
							        <mx:Label text="(estimated)"/>
				    			</mx:VBox>
						    </mx:Component>
						</mx:headerRenderer>
					</mx:DataGridColumn>
					<mx:DataGridColumn  dataField="@calcConcentration" width="90" headerText="Est. Conc.">
                       <mx:headerRenderer > 
						    <mx:Component>
						    	<mx:VBox verticalGap="0"   horizontalAlign="center" verticalAlign="middle">
							        <mx:Label text="Conc. ng/uL"/>
							        <mx:Label text="(estimated)"/>
				    			</mx:VBox>
						    </mx:Component>
						</mx:headerRenderer>
					</mx:DataGridColumn>
					<mx:DataGridColumn   labelFunction="getSeqPrepLibFragmentSizeRange" width="90" headerText="Lib Fragment Size">
                       <mx:headerRenderer > 
						    <mx:Component>
						    	<mx:VBox verticalGap="0"   horizontalAlign="center" verticalAlign="middle">
							        <mx:Label text="Frag Size"/>
							        <mx:Label text="(library)"/>
				    			</mx:VBox>
						    </mx:Component>
						</mx:headerRenderer>
					</mx:DataGridColumn>
					<mx:DataGridColumn  dataField="@seqPrepLibConcentration" width="90" headerText="Lib Conc.">
                       <mx:headerRenderer > 
						    <mx:Component>
						    	<mx:VBox verticalGap="0"   horizontalAlign="center" verticalAlign="middle">
							        <mx:Label text="Conc. ng/uL"/>
							        <mx:Label text="(library)"/>
				    			</mx:VBox>
						    </mx:Component>
						</mx:headerRenderer>
					</mx:DataGridColumn>
					<mx:DataGridColumn  dataField="@seqPrepStockLibVol" width="90" headerText="Flow Cell Stock Lib Vol">
                       <mx:headerRenderer > 
						    <mx:Component>
						    	<mx:VBox verticalGap="0"   horizontalAlign="center" verticalAlign="middle">
							        <mx:Label text="Flow Cell Stock"/>
							        <mx:Label text="Lib Vol (uL)"/>
				    			</mx:VBox>
						    </mx:Component>
						</mx:headerRenderer>
					</mx:DataGridColumn>
					<mx:DataGridColumn  dataField="@seqPrepStockEBVol" width="90" headerText="Flow Cell Stock EB Vol">
                       <mx:headerRenderer > 
						    <mx:Component>
						    	<mx:VBox verticalGap="0"   horizontalAlign="center" verticalAlign="middle">
							        <mx:Label text="Flow Cell Stock"/>
							        <mx:Label text="EB Vol (uL)"/>
				    			</mx:VBox>
						    </mx:Component>
						</mx:headerRenderer>
					</mx:DataGridColumn>
					<mx:DataGridColumn  dataField="@numberSequencingCyclesActual" width="90" headerText="# Cycles (actual)">
                       <mx:headerRenderer > 
						    <mx:Component>
						    	<mx:VBox verticalGap="0"   horizontalAlign="center" verticalAlign="middle">
							        <mx:Label text="# Cycles"/>
							        <mx:Label text="(actual)"/>
				    			</mx:VBox>
						    </mx:Component>
						</mx:headerRenderer>
					</mx:DataGridColumn>
					<mx:DataGridColumn  dataField="@clustersPerTile" width="90" headerText="Clusters per Tile">
                       <mx:headerRenderer > 
						    <mx:Component>
						    	<mx:VBox verticalGap="0"   horizontalAlign="center" verticalAlign="middle">
							        <mx:Label text="Clusters per"/>
							        <mx:Label text="Tile"/>
				    			</mx:VBox>
						    </mx:Component>
						</mx:headerRenderer>
					</mx:DataGridColumn>
					<mx:DataGridColumn  dataField="@fileName" width="100" headerText="File name"/>
					<mx:DataGridColumn  dataField="@workflowStatus" width="100" headerText="Status"/>
				</mx:columns>			
			</mx:DataGrid>			
		</mx:VBox>
	</mx:VDividedBox>
	<mx:ControlBar horizontalAlign="right">
	    <mx:HBox width="100%" horizontalAlign="left">
			<mx:LinkButton textDecoration="underline" label="Refresh"  icon="@Embed('../../assets/action_refresh.gif')" 
				 toolTip="Refresh worklist"/>
	    </mx:HBox>
	</mx:ControlBar>	
</mx:Panel>
