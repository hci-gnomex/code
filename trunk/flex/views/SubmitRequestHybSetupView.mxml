<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" 
	label="Hyb setup" width="100%" height="100%" enabled="false">
<mx:Script> 
	<![CDATA[
		import mx.collections.XMLListCollection;

		public function getCheckedCodeSlideSource():String {
			if (this.coreSlideSourceCheckbox.selected == true) {
				return "CORE";
			} else if (this.clientSlideSourceCheckbox.selected == true ) {
				return "CLIENT";
			} else if (this.stripSlideSourceCheckbox.selected== true) {
				return "REUSE";
			} else {
				return '';
			}
		}
		private function toggleCheckedCodeSlideSource(checkBoxNumber:int):void {
			if (checkBoxNumber == 1) {
				this.clientSlideSourceCheckbox.selected = false;
				this.stripSlideSourceCheckbox.selected  = false;
			} else if (checkBoxNumber == 2) {
				this.coreSlideSourceCheckbox.selected = false;
				this.stripSlideSourceCheckbox.selected  = false;
			} else if (checkBoxNumber == 3) {
				this.coreSlideSourceCheckbox.selected  = false;
				this.clientSlideSourceCheckbox.selected = false;
			} 
		}
		
		private function propagateCheckCodeSlideSource():void {
			for each (var hyb:Object in parentDocument.hybs) {
				hyb.@codeSlideSource = this.getCheckedCodeSlideSource();
			}
			callLater(parentDocument.hybsView.checkHybsCompleteness);
		}
		
		private function propagateSlideDesign():void {
			for each (var hyb:Object in parentDocument.hybs) {
				hyb.@idSideDesign = this.slideProductCombo.selectedItem.@idSlideDesign;
			}
			callLater(parentDocument.hybsView.checkHybsCompleteness);
		}
		
		public function checkHybSetupCompleteness():void {
			if (parentDocument == null) {
				return;
			}
			if (!parentDocument.isMicroarrayState()) {
				return;
			}
			
        	if (this.numberOfHybs.text != null && this.numberOfHybs.text != '' &&
        	    this.slideProductCombo.selectedItem != null && this.slideProductCombo.selectedItem.@idSlideProduct != '' &&
        	    this.getCheckedCodeSlideSource() != '' && parentDocument.isSampleTypeCompatibile() ) {
        	    	
        		parentDocument.hybsView.enabled = true;
        	    	
        	} else if (parentDocument.request.@idRequest != '0') {
        		parentDocument.hybsView.enabled = true;
        	} else {
        		parentDocument.hybsView.enabled = false;
        	}
        	parentDocument.enableNextButtons();
        }
       
        private function postHybSetupCompleteness(isComplete:Boolean):void { 

        	if (!isComplete) {
	        	if (parentDocument.theTab.contains(this)) {
		        	this.enabled = false;
	        	} 

	        	if (parentDocument.theTab.contains(parentDocument.hybsView)) {
		        	parentDocument.hybsView.enabled = false;
	        	} 

	        	parentDocument.confirmView.enabled = false;
    		} else {
    			parentDocument.hybsView.checkHybsCompleteness();
    		}        	
        }        
        
        public function checkForSlideProductWarning():void {
        	if (this.slideProductCombo.dataProvider.length == 1) {
        		slideProductStack.selectedIndex = 1;
        	} else {
        		slideProductStack.selectedIndex = 0;
        	}
        }  
        
        public function initializeSlideProductCombo():void {
        	if (parentDocument == null) {
        		return;
        	}
			parentApplication.filteredSlideProductListForSubmitRequests.refresh();

			slideProductCombo.selectedIndex = -1;
			for each(var slideProduct:Object in slideProductCombo.dataProvider) {
				if (slideProduct.@idSlideProduct == parentDocument.request.@idSlideProduct) {
					slideProductCombo.selectedItem = slideProduct;
					break;
				}
			}
			checkForSlideProductWarning();
		}
		private function clearHybSlideDesigns():void {
			if (slideProductCombo.selectedItem == null ||
			    slideProductCombo.selectedItem.@idSlideProduct == '' ||
			    parentDocument.request.@idSlideProduct == '' ||
				parentDocument.request.@idSlideProduct != slideProductCombo.selectedItem.@idSlideProduct) {
			
				for each (var hyb:Object in parentDocument.hybs) {
					hyb.@idSlideDesign = '';
				}
				parentDocument.hybsView.checkHybsCompleteness();
			}
			
		}
		public function assignSlideNumbers():void {
			if (slideProductCombo.selectedItem == null || slideProductCombo.selectedItem.@idSlideProduct == '') {
				return;
			}
			if (slideProductCombo.selectedItem.@arraysPerSlide == '' ||
				slideProductCombo.selectedItem.@arraysPerSlide == '1') {
				parentDocument.hybsView.slideNumberColumn.visible = false;		
			} else {
				parentDocument.hybsView.slideNumberColumn.visible = true;
			}
			var slideNumber:int = 0;
			var count:int = 0;
			var firstTime:Boolean = true;
			var useAltColor:Boolean = true;
			for each(var hyb:Object in parentDocument.hybs) {
				if (slideProductCombo.selectedItem.@arraysPerSlide == '' ||
				    slideProductCombo.selectedItem.@arraysPerSlide == '1') {
					slideNumber++;    
					hyb.@showSlideIcon = 'Y';	
					hyb.@altColor = false;
				} else {
					if (firstTime || count == slideProductCombo.selectedItem.@arraysPerSlide) {
						count = 0;
						slideNumber ++;
						hyb.@showSlideIcon = 'Y';
						useAltColor = !useAltColor;
						hyb.@altColor = useAltColor;
					} else {
						hyb.@showSlideIcon = 'N';							
						hyb.@altColor = useAltColor;
					}
				}
				hyb.@slideNumber = slideNumber;
				count++;
				firstTime = false;
			}
		}		
		
		public function getDefaultSlideDesign():Object {
			var slideDesign:Object = null;
			if (parentDocument == null) {
				return slideDesign;
			}
			
			if (slideProductCombo.selectedItem != null) {
				parentDocument.selectedIdSlideProduct = slideProductCombo.selectedItem.@idSlideProduct;
				parentDocument.hybsView.slideDesigns = new XMLListCollection(parentApplication.manageDictionaries.lastResult.Dictionary.(@className == 'hci.gnomex.model.SlideDesign').DictionaryEntry.(@value == '' || @idSlideProduct == parentDocument.selectedIdSlideProduct));
				
				// If there is only one slide design (besides the blank entry) for the slide product,
				// set all of the hybs to it.
				if (parentDocument.hybsView.slideDesigns.length == 2) {
					slideDesign = parentDocument.hybsView.slideDesigns[1];
				}
			}
			
			return slideDesign;

		}
      
	]]>
</mx:Script>
	<mx:VBox width="100%" height="100%" verticalGap="20" paddingTop="10">
		<mx:HBox width="100%" horizontalGap="0">
			<mx:Image source="{parentApplication.iconBullet}"/>
			<mx:Label text="Select an organism:" width="300" />
			<mx:ComboBox labelField="@display" width="300" id="organismCombo">							
				<mx:change>parentApplication.filteredSlideProductListForSubmitRequests.refresh();slideProductCombo.selectedIndex = -1;clearHybSlideDesigns();checkHybSetupCompleteness();checkForSlideProductWarning()</mx:change>
				<mx:dataProvider></mx:dataProvider>
			</mx:ComboBox>
		</mx:HBox>
		<mx:HBox width="100%" horizontalGap="0">
			<mx:Image source="{parentApplication.iconBullet}"/>
			<mx:Label text="Select an experiment category:" width="300" />
			<mx:ComboBox labelField="@display" width="300" id="microarrayCategoryCombo">							
				<mx:change>parentApplication.filteredSlideProductListForSubmitRequests.refresh();slideProductCombo.selectedIndex = -1;clearHybSlideDesigns();checkHybSetupCompleteness();checkForSlideProductWarning();callLater(parentDocument.checkForSampleTypeCompatibility)</mx:change>
				<mx:dataProvider></mx:dataProvider>
			</mx:ComboBox>
		</mx:HBox>
		<mx:HBox width="100%" horizontalGap="0">
			<mx:Image source="{parentApplication.iconBullet}"/>
			<mx:Label text="Select on of the following:" width="300" />
			<mx:RadioButtonGroup id="customVsCatalogRadioGroup"/>
			<mx:RadioButton label="Catalog microarray" groupName="customVsCatalogRadioGroup" id="isCatalogRadio" selected="true" click="parentApplication.filteredSlideProductListForSubmitRequests.refresh();slideProductCombo.selectedIndex = -1;clearHybSlideDesigns();checkHybSetupCompleteness();checkForSlideProductWarning();callLater(parentDocument.checkForSampleTypeCompatibility)">
				<mx:change>parentApplication.filteredSlideProductListForSubmitRequests.refresh();slideProductCombo.selectedIndex = -1;checkHybSetupCompleteness()</mx:change>
			</mx:RadioButton>
			<mx:RadioButton label="Custom microarray" groupName="customVsCatalogRadioGroup" id="isCustomRadio" click="parentApplication.filteredSlideProductListForSubmitRequests.refresh();slideProductCombo.selectedIndex = -1;clearHybSlideDesigns();checkHybSetupCompleteness();checkForSlideProductWarning();callLater(parentDocument.checkForSampleTypeCompatibility)">
				<mx:change>parentApplication.filteredSlideProductListForSubmitRequests.refresh();slideProductCombo.selectedIndex = -1;checkHybSetupCompleteness()</mx:change>
			</mx:RadioButton>
		</mx:HBox>
		<mx:HBox width="100%" horizontalGap="0">
			<mx:Image source="{parentApplication.iconBullet}"/>
			<mx:Text width="300">
				<mx:htmlText><![CDATA[Select the microarray slide or slide set to be used <BR> for these hybridizations:]]></mx:htmlText>
			</mx:Text>
			<mx:ViewStack id="slideProductStack" width="100%" height="100%">
			    <mx:HBox>
					<mx:ComboBox labelField="@display" width="420" id="slideProductCombo"  change="{parentDocument.hybsView.initializeHybsGrid();clearHybSlideDesigns();parentDocument.initializeSlideDesigns();propagateSlideDesign();assignSlideNumbers();checkHybSetupCompleteness()}" >							
						<mx:dataProvider>{parentApplication.filteredSlideProductListForSubmitRequests}</mx:dataProvider>
					</mx:ComboBox>
			    </mx:HBox>
			    <mx:HBox width="100%" backgroundColor="#ffffff" borderStyle="inset" verticalAlign="middle">
					<mx:Text width="100%" text="{'No ' + (isCatalogRadio.selected ? 'catalog ': 'custom ') + parentDocument.requestCategoryName + ' ' + organismCombo.selectedItem.@display + ' ' + microarrayCategoryCombo.selectedItem.@display + ' slides are listed.  Please contact Brian Dalley about slide stock.'}" color="#0000ff">								
					</mx:Text>						    	
			    </mx:HBox>
				
				
			</mx:ViewStack>
		</mx:HBox>
		<mx:HBox width="100%" horizontalGap="0" id="numberOfHybsContainer">
			<mx:Image source="{parentApplication.iconBullet}"/>
			<mx:Text width="300" >
				<mx:htmlText><![CDATA[How many hybridizations will be performed on this <BR>experiment request?]]></mx:htmlText>
			</mx:Text>
			<mx:TextInput width="40" id="numberOfHybs" change="parentDocument.hybsView.initializeHybsGrid();clearHybSlideDesigns();parentDocument.initializeSlideDesigns();checkHybSetupCompleteness()">
				
			</mx:TextInput>
		</mx:HBox>
		<mx:HBox width="100%" horizontalGap="0" id="slideSourceContainer">
			<mx:Image source="{parentApplication.iconBullet}"/>
			<mx:Label text="Where will the microarrays come from?" width="300" />
			<mx:VBox verticalGap="1">
				<mx:CheckBox label="New microarray purchased from core facility"  id="coreSlideSourceCheckbox"   click="this.toggleCheckedCodeSlideSource(1);parentDocument.hybsView.initializeHybsGrid();clearHybSlideDesigns();parentDocument.initializeSlideDesigns();propagateCheckCodeSlideSource();checkHybSetupCompleteness();"/>
				<mx:CheckBox label="New microarray purchased by lab"  id="clientSlideSourceCheckbox"  click="this.toggleCheckedCodeSlideSource(2);parentDocument.hybsView.initializeHybsGrid();clearHybSlideDesigns();parentDocument.initializeSlideDesigns();propagateCheckCodeSlideSource();checkHybSetupCompleteness();"/>
				<mx:CheckBox label="Strip and reuse existing microarray" id="stripSlideSourceCheckbox"  click="this.toggleCheckedCodeSlideSource(3);parentDocument.hybsView.initializeHybsGrid();clearHybSlideDesigns();parentDocument.initializeSlideDesigns();propagateCheckCodeSlideSource();checkHybSetupCompleteness();"/>
			</mx:VBox>
		</mx:HBox>
		
	</mx:VBox>
</mx:Canvas>
