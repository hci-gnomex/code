<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" 
	layout="vertical" width="286" height="200" 
	xmlns:views="views.*" 
	showCloseButton="true" 
	close="{PopUpManager.removePopUp(this)}" 
	title="Guest Login" 	 
	borderThickness="4" defaultButton="{loginButton}">
	
	<mx:VBox verticalGap="20" fontSize="10" paddingLeft="8" verticalAlign="middle" styleName="form" horizontalAlign="center" paddingRight="8" width="100%" height="100%">
		<mx:Image id="captcha"  width="180" height="60"/>
		<mx:HBox width="100%" verticalAlign="middle">
			<mx:Label text="Enter the code:"/>
			<mx:TextInput  id="phrase" width="100%"/> 
		</mx:HBox> 
		
	</mx:VBox>
	<mx:ControlBar horizontalAlign="right">
		<mx:Button label="Login" click="submit()"  id="loginButton" enabled="{phrase.text != '' ? true : false}"/>
		
	</mx:ControlBar>
	
	<mx:HTTPService 
    id="getCaptchaURL" 
    url="CustomCaptchaURLServlet.gx"
    resultFormat="e4x"
    result="onGetCaptchaURL(event)"
    fault="onFailCreateSecurityAdvisorForGuest(event)"
    showBusyCursor="false"
    useProxy="false">
    <mx:request>
    </mx:request>
    </mx:HTTPService > 	
    
	<mx:HTTPService 
    id="createSecurityAdvisorForGuest" 
    url="CreateSecurityAdvisorForGuest.gx"
    resultFormat="e4x"
    result="onCreateSecurityAdvisorForGuest(event)"
    fault="onFailCreateSecurityAdvisorForGuest(event)"
    destination="createSecurityAdvisorForGuest"
    showBusyCursor="false"
    useProxy="false">
    <mx:request>
    </mx:request>
    </mx:HTTPService > 	
    
	
	<mx:Script>
		<![CDATA[
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;   
			import mx.rpc.events.FaultEvent;   
			import mx.controls.Alert; 
			
			private var imageUrl:String = "";
			
			public function init():void {
				getCaptchaURL.send();	
			}
			
			
			private function onGetCaptchaURL(event:ResultEvent):void {
			 	if (!(getCaptchaURL.lastResult is XML) ||
            	    getCaptchaURL.lastResult.name() != 'CaptchaURL') {
            		Alert.show("Login failed.");  
            		return;	
            	}
            	// Workaround for IE problem.  Cannot serve captcha image
				// from SSL due to SSLException thrown in
				// servlet code.  We will use non-secure (http:)
				// request to get captcha image.  Because session
				// is shared between http: and https:, the subsequent
				// call to CreateSecurityAdvisorForGuest using https:
				// works because session contains expected
				// captcha phrase.  
				//var appUrl:String = this.loaderInfo.url as String;
				//var pattern:RegExp = /gnomexFlex.swf/;
				//imageUrl = appUrl.replace(pattern, "Captcha.jpg");
				//imageUrl = imageUrl.replace("https", "http");
				imageUrl = getCaptchaURL.lastResult.@url;
				captcha.load(imageUrl);
            	
			}

			private function submit():void {
				var params:Object = new Object();
				params.captchafield = phrase.text;
				
				createSecurityAdvisorForGuest.send(params);
				
			}
			
			private function onCreateSecurityAdvisorForGuest(event:ResultEvent):void {
			 	if (!(createSecurityAdvisorForGuest.lastResult is XML) ||
            	    createSecurityAdvisorForGuest.lastResult.name() != 'SecurityAdvisor') {
            		Alert.show("Login failed.");  
            		return;	
            	}
            	PopUpManager.removePopUp(this);
            	parentApplication.getSecurityAdvisorForGuest.send();
            	
			}

			private function onFailCreateSecurityAdvisorForGuest(event:FaultEvent):void {
				captcha.load(imageUrl);
            }

		]]>
	</mx:Script>
</mx:TitleWindow>
