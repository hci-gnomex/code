<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" 
				xmlns:renderers="views.renderers.*"
				layout="vertical" 
				title="Enter Work Authorization" 
				width="642" 
				height="395" 
				defaultButton="{saveButton}" 
				creationComplete="init()" 
				titleIcon="@Embed(source='../../assets/work_auth_form.png')">
    
    <mx:HTTPService 
    id="submitWorkAuthForm" 
    url="SubmitWorkAuthForm.gx"
    resultFormat="e4x" 
    showBusyCursor="true"
    result="onSubmitWorkAuthForm(event)"
    fault="parentApplication.onFailHttpRequest('Unable to submit work authorization form', event)"
    method="POST"
    useProxy="false">
    </mx:HTTPService >  
	
	<mx:HTTPService 
		id="getLab" 
		url="GetLab.gx"
		destination="getLab"
		showBusyCursor="true"
		resultFormat="e4x"
		result="onGetLab(event)"
		fault="parentApplication.onFailHttpRequest('Failed to get group', event)"
		useProxy="false">
		<mx:request>
			<idLab>{labCombo.selectedItem.@idLab}</idLab>
		</mx:request>
	</mx:HTTPService >

<mx:Script>
	<![CDATA[
		import mx.collections.XMLListCollection;
		import mx.controls.Alert;
		import mx.managers.PopUpManager;
		import mx.rpc.events.FaultEvent;
		import mx.rpc.events.ResultEvent;
		
		
		[Bindable]
		private var coreFacilities:XMLListCollection = new XMLListCollection();

		private var validEmail:Boolean = false;
		
		private function init():void {
			// totalDollarAmount field removed for now.
			// To reenable remove code lines and make sure to uncomment 
			// data checks in "I Agree" and "Save" button enabled events
			totalDollarAmountLabel.visible = false;
			totalDollarAmount.visible = false;			
		}
		private function save():void {
			var errorMessage:String = "";
			
			errorMessage = checkFormCompleteness();
			if(errorMessage != "")
			{
				Alert.show(errorMessage, "Please fix the following errors with this form before proceeding:");
				project.setFocus();
				return;
			}
			var params:Object = new Object();
			params.accountName = this.accountName.text;
			params.startDate = this.startDatePicker.text;
			params.expirationDate = this.expirationDatePicker.text;
			params.idLab = this.labCombo.selectedItem.@idLab;
			params.idCoreFacility = this.coreCombo.selectedItem.@idCoreFacility;
			params.accountNumberBus = this.bus.text;
			params.accountNumberOrg = this.org.text;
			params.accountNumberFund = this.fund.text;
			params.accountNumberActivity = this.activity.text;
			params.accountNumberProject = this.project.text;
			params.accountNumberAccount = this.account.text;
			params.accountNumberAu = this.au.text;
			params.accountNumberYear = this.year.text;
			params.idFundingAgency = this.fundingAgencyCombo.selectedItem.@value;
			params.isPO = "N";
			params.submitterEmail = this.emailAddress.text;
			params.totalDollarAmountDisplay = this.totalDollarAmount.text;
			
			submitWorkAuthForm.send(params);

		}
		
		private function checkFormCompleteness():String{
			var errorMessage:String = "";
			var regEx:RegExp = /[^0-9]/;
			
			if(labCombo.selectedIndex == 0)
				errorMessage += "- Please select a lab\n";
			
			if(coreCombo.selectedIndex == 0)
				errorMessage += "- Please select a core facility\n";
			
			if (this.project.text != '' && this.activity.text != '')
				errorMessage +="- The chartfield must contain either project or activity, but not both.\n";
			
			if(bus.text.length != 2 || org.text.length != 5 || fund.text.length != 4 || account.text.length != 5 || au.text.length != 1 || year.text.length != 4 || 
				(activity.text.length != 5 && project.text == '') || (project.text.length != 8 && activity.text == ''))
				errorMessage += "- Please check the length of your account number.\n";

			if(bus.text.search(regEx) != -1 || org.text.search(regEx) != -1 || fund.text.search(regEx) != -1 || account.text.search(regEx) != -1 || au.text.search(regEx) != -1 ||
				year.text.search(regEx) != -1 || activity.text.search(regEx) != -1 || project.text.search(regEx) != -1)
				errorMessage += "- Only numbers are allowed in the chartfield.\n";
			
			if(accountName.text == "")
				errorMessage += "- Please provide a name for your account.\n";
			
			if(fundingAgencyCombo.selectedIndex == 0)
				errorMessage += "- Please select a funding agency.\n";
			
			if(expirationDatePicker.text == "")
				errorMessage += "- Please pick an expiration date.\n";
			
			if(validEmail == false)
				errorMessage += "- Please enter a valid email address.\n";
			
			if(iAgree.selected == false)
				errorMessage += "- Please agree to the terms and conditions.\n";
			
			return errorMessage;
		}
		
		private function onSubmitWorkAuthForm(event:ResultEvent):void {
        	if (submitWorkAuthForm.lastResult.name() == "SUCCESS") {
        		Alert.show("Work authorization for account " + 
        		"'" + this.accountName.text + "'"+
        		 " has been submitted to " + coreCombo.selectedItem.@display +
        		 ".\n\n" + 
        		 "After the account information is reviewed and approved, " +
        		 "you will be notified by email that experiment " +
        		 "requests can now be submitted against this account in GNomEx.");
        		 PopUpManager.removePopUp(this);
        	} else {
        		Alert.show(submitWorkAuthForm.lastResult..ACTMESSAGE.@TEXT);
        	}        	
        }     
		
		private function groupSelected():void {
			coreCombo.dataProvider = null;
			coreCombo.dropdown.dataProvider = null;
			
			if(labCombo.selectedIndex >= 0) {
				getMembersOfLab();			
			}
		}
		
		private function getMembersOfLab():void {
			if (this.labCombo.selectedItem != null && this.labCombo.selectedItem.@idLab != null) {
				getLab.send();				
			}
		}
		
		private function onGetLab(event:ResultEvent):void {
			if ( getLab.lastResult == null || getLab.lastResult.name() != "OpenLabList" ) {
				return;
			}
			var lab:Object = getLab.lastResult..Lab.(@idLab == labCombo.selectedItem.@idLab);
			coreFacilities = new XMLListCollection(lab.coreFacilities.CoreFacility);
			
			var blankNode:XML = new XML("<CoreFacility idCoreFacility='' display=''/>");
			coreFacilities.addItemAt(blankNode, 0);
			coreCombo.dataProvider = coreFacilities;
			coreCombo.dropdown.dataProvider = coreFacilities;
		}
		
		
	]]>
</mx:Script>
	
	<mx:StringValidator required="true" source="{bus}" property="text" maxLength="2" minLength="2" tooShortError="Must be 2 digits"/>
	<mx:StringValidator required="true" source="{org}" property="text" maxLength="5" minLength="5" tooShortError="Must be 5 digits"/>
	<mx:StringValidator required="true" source="{fund}" property="text" maxLength="4" minLength="4" tooShortError="Must be 4 digits"/>
	<mx:StringValidator required="false" source="{activity}" property="text" maxLength="5" minLength="0"/>
	<mx:StringValidator required="false" source="{project}" property="text" maxLength="8" minLength="0"/>
	<mx:StringValidator required="true" source="{account}" property="text" maxLength="5" minLength="5" tooShortError="Must be 5 digits"/>
	<mx:StringValidator required="true" source="{au}" property="text" maxLength="1" minLength="1" requiredFieldError="This field required"/>
	<mx:StringValidator required="true" source="{year}" property="text" maxLength="4" minLength="4" tooShortError="Must be 4 digits"/>
	<mx:StringValidator required="true" source="{accountName}" property="text" requiredFieldError="This field required"/>
	<mx:EmailValidator required="true" source="{emailAddress}" property="text" invalid="{validEmail = false}" valid="{validEmail = true}"/> 
	<mx:NumberValidator required="true" source="{labCombo}" property="selectedIndex" minValue="1" lowerThanMinError="This field required"/>
	<mx:NumberValidator required="true" source="{fundingAgencyCombo}" property="selectedIndex" minValue="1" lowerThanMinError="This field required"/>
	<mx:NumberValidator required="true" source="{coreCombo}" property="selectedIndex" minValue="1" lowerThanMinError="This field required"/>
	
	
	<mx:VBox height="100%" width="100%" verticalGap="8" styleName="form" paddingLeft="4" paddingBottom="4" paddingRight="4" paddingTop="4">
		<mx:HBox width="100%" horizontalAlign="left" verticalAlign="middle" horizontalGap="4">
			<mx:Label text="Lab" width="120"/>
			<renderers:FilterComboBox width="492" id="labCombo"
				labelField="@name" 
				prompt="Select a lab..."
				close="{groupSelected()}"
				dataProvider="{parentApplication.workAuthLabList}">
			</renderers:FilterComboBox>
		</mx:HBox>
		<mx:HBox width="100%" horizontalAlign="left" verticalAlign="middle" horizontalGap="4">
			<mx:Label text="Core Facility" width="120"/>
			<mx:ComboBox width="492" id="coreCombo" labelField="@display" >
			</mx:ComboBox>
		</mx:HBox>
	    <mx:VBox verticalGap="0">
	        <mx:HBox horizontalGap="4">
	            <mx:Text text="Chartfield to be charged" textAlign="left" width="120"/>
	            <mx:VBox verticalGap="0">
	            	<mx:Label text="Bus"/>
	            	<mx:TextInput id="bus" width="40" maxChars="2"/>
	            	<mx:Label text="2 digits" styleName="labelSmall"/>
	            </mx:VBox>
				<mx:VBox verticalGap="0">
					<mx:Label text="Org"/>
					<mx:TextInput id="org" width="40" maxChars="5"/>
					<mx:Label text="5 digits" styleName="labelSmall"/>
				</mx:VBox>
				<mx:VBox verticalGap="0">
					<mx:Label text="Fund"/>
					<mx:TextInput id="fund" width="40" maxChars="4"/>
					<mx:Label text="4 digits" styleName="labelSmall"/>
				</mx:VBox>
				<mx:VBox verticalGap="0">
					<mx:Label text="Activity"/>
					<mx:TextInput id="activity" width="50" maxChars="5"/>
					<mx:Label text="5 digits" styleName="labelSmall"/>
				</mx:VBox>
				<mx:VBox verticalGap="0">
					<mx:Label text="Project"/>
					<mx:TextInput id="project" width="60" maxChars="8"/>
					<mx:Label text="8 digits" styleName="labelSmall"/>
				</mx:VBox>
				<mx:VBox verticalGap="0">
					<mx:Label text="Account"/>
					<mx:TextInput id="account" width="50" maxChars="5"/>
					<mx:Label text="5 digits" styleName="labelSmall"/>
				</mx:VBox>
				<mx:VBox verticalGap="0">
					<mx:Label text="A/U"/>
					<mx:TextInput id="au" width="35" maxChars="1"/>
					<mx:Label text="1 digit" styleName="labelSmall"/>
				</mx:VBox>
				<mx:VBox verticalGap="0">
					<mx:Label text="Year"/>
					<mx:TextInput id="year" width="40" maxChars="4"/>
					<mx:Label text="4 digit" styleName="smallLabel"/>
				</mx:VBox>
		</mx:HBox>
	    	
	    </mx:VBox>
        <mx:HBox width="100%" verticalAlign="middle" horizontalGap="4">
        	<mx:Label text="Title of Account" width="120"/>
        	<mx:TextInput width="100%" id="accountName"></mx:TextInput>
        </mx:HBox>
        <mx:HBox width="100%" verticalAlign="middle" horizontalGap="4">
        	<mx:Label text="Funding Agency" width="120"/>
        	<mx:ComboBox width="492" id="fundingAgencyCombo"
        		labelField="@display" 
        		dataProvider="{parentApplication.dictionaryManager.xml.Dictionary.(@className == 'hci.gnomex.model.FundingAgency').DictionaryEntry}">
        	</mx:ComboBox>
        </mx:HBox>
        <mx:HBox width="100%" verticalAlign="middle" horizontalGap="0">
			<mx:Label text="Start Date" width="126"/>
			<mx:DateField id="startDatePicker"></mx:DateField>
			<mx:Spacer width="20"/>
        	<mx:Label text="Effective Until"/>
        	<mx:DateField id="expirationDatePicker"></mx:DateField>
        	<mx:Spacer width="20"/>
        	<mx:Label id="totalDollarAmountLabel" text="Total Dollar Amount"/>
        	<mx:TextInput id="totalDollarAmount" width="75"/>
        </mx:HBox>
        <mx:HBox width="100%" verticalAlign="middle" horizontalGap="4">
        	<mx:Label text="Your email address" width="120"/>
        	<mx:TextInput width="100%" id="emailAddress"></mx:TextInput>
        </mx:HBox>
        <mx:VBox verticalGap="0" width="100%">
    	    <mx:Text text="As the Principal Investigator (P.I.) or authorized personnel of the account listed above I authorize the Core Facility to charge the account for work performed on my laboratory’s behalf during the dates indicated, not to exceed the dollar amount.  I understand that this account will be billed automatically and that I will receive a detailed statement of services for any month in which my account was charged." width="100%"/>
	        <mx:CheckBox label="I agree" color="#1500DA" enabled="true" fontSize="11" width="100%" textAlign="center" id="iAgree"  fontWeight="bold" textRollOverColor="#3320E6" textSelectedColor="#3320E6"/>
        </mx:VBox>
    </mx:VBox>
	<mx:ControlBar horizontalAlign="right">
		<mx:Button label="Save" id="saveButton" click="save()" icon="@Embed(source='../../assets/save.png')" enabled="true" disabledIcon="@Embed(source='../../assets/save_disable.png')"/>
		<mx:Button label="Cancel" click="{mx.managers.PopUpManager.removePopUp(this)}"/>
	</mx:ControlBar>

	
</mx:TitleWindow>
