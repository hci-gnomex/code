<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas label="Visibility" 
	xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:util="views.util.*"  enabled="false"
	 width="100%" height="100%" show="init()" >
	<mx:states>
		<mx:State name="EditState">
			<mx:SetProperty name="enabled" value="true"/>
			<mx:RemoveChild target="{textarea1}"/>
		</mx:State>
	</mx:states>
	
  <mx:HTTPService  
    id="getLab" 
    url="GetLab.gx"
    destination="getLab"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetLab(event)"
    fault="parentApplication.onFailHttpRequest('Failed to get group', event)"
    method="POST"
    useProxy="false">
    <mx:request>
    	<idLab>{idLab}</idLab>
    </mx:request>
    	
   </mx:HTTPService>
	
<mx:Script>
	<![CDATA[
		import hci.flex.controls.CheckBox;
		
		import mx.collections.XMLListCollection;
		import mx.controls.RadioButton;
		import mx.controls.Spacer;
		import mx.events.ListEvent;
		import mx.rpc.events.ResultEvent;
		
		import views.renderers.CheckBoxIsSelectedChipType;
		import views.util.PromptXMLListCollection;
	
		private var validNumberOfSamples:Boolean = true;
		private var validConcentration:Boolean = true;
		
		[Bindable]
		private var idLab:Object;
		
		private var idInstitution:Object;
		
		[Bindable]
		private var possibleCollaborators:PromptXMLListCollection;

		[Bindable]
		private var possibleInstitutions:PromptXMLListCollection;

		public function init():void {
			checkSecurity();
			if (this.currentState == "EditState") {
				this.visibilityRadioGroup.selectedValue = parentDocument.request.@codeVisibility;
			} else {
				this.visibilityRadioGroup.selectedValue = 'MEM';
			}
			this.collaboratorCombo.selectedItem = null;
			checkVisibilitySetupCompleteness();
			
			if (this.currentState == "EditState" || parentDocument.isAmendState()) {
				idLab = parentDocument.request.@idLab;
				idInstitution = parentDocument.request.@idInstitution;
			} else {
				idLab = parentDocument.setupView.labCombo.selectedItem.@idLab;
				idInstitution = parentDocument.visibilityView.institutionCombo.selectedItem != null ? parentDocument.visibilityView.institutionCombo.selectedItem.@idInstitution : '';
			}
			getLab.send();
		}
		
		public function checkSecurity():void {

		}

		private function onGetLab(event:ResultEvent):void {
			if (getLab.lastResult.name() == "OpenLabList") {
				var emptyNode:XML = new XML("<AppUser " +
				    " idAppUser=''" +
				    " displayName=''"  +
					"/>");
				possibleCollaborators = new PromptXMLListCollection(emptyNode, new XMLListCollection(getLab.lastResult..Lab.(@idLab == idLab).possibleCollaborators.AppUser.(@isActive == 'Y')));
				possibleInstitutions = new PromptXMLListCollection(emptyNode, new XMLListCollection(getLab.lastResult..Lab.(@idLab == idLab).institutions.Institution.(@isActive == 'Y')));

				this.institutionCombo.enabled = this.possibleInstitutions.length > 1;
				this.radioInstitutionVisibility.enabled = this.possibleInstitutions.length > 1;
				if (this.idInstitution != null) {
					for each(var inst:Object in possibleInstitutions) {
						if (inst.@idInstitution == this.idInstitution) {
							this.institutionCombo.selectedItem =  inst;
							break;
						}
					}
				} else {
					this.institutionCombo.selectedIndex = 0;
				}
			}
		}

        public function checkVisibilitySetupCompleteness():Boolean {
        	var isComplete:Boolean = false;
        	if (parentDocument.isEditState()) {
        		isComplete = true;
        	} else if (this.visibilityRadioGroup.selectedValue != null && this.visibilityRadioGroup.selectedValue != '') {

				if (this.visibilityRadioGroup.selectedValue == 'INST') {
					if (institutionCombo.selectedItem != null && institutionCombo.selectedItem.hasOwnProperty("@idInstitution") && institutionCombo.selectedItem.@idInstitution != '') {
						isComplete = true;						
					}					
				} else {
					isComplete = true;
					
				}
        	} 

			if (this.currentState != "EditState") {
	        	parentDocument.confirmView.enabled = isComplete; 
        	}
        	
    		parentDocument.enableNextButtons();

        	
    		return isComplete;
    	    	
        }
        
		private function addCollaborator():void {
			parentDocument.dirty.setDirty();
			var node:XML = new XML("<AppUser " +
			    " idAppUser='" + collaboratorCombo.selectedItem.@idAppUser + "'" +
			    " displayName='" + collaboratorCombo.selectedItem.@displayName + "'" +
				"/>");
			this.collaborators.addItem(node);
		}
		
		private function removeCollaborator():void {
			parentDocument.dirty.setDirty();
			if (collaboratorGrid.selectedIndex != -1) {
				collaborators.removeItemAt(collaboratorGrid.selectedIndex);
			}
		}
	]]>
</mx:Script>

  <mx:XMLListCollection id="collaborators" source="{parentDocument.request.collaborators.AppUser}"/>
  <mx:Canvas width="100%" height="100%">
        	
	<mx:VBox width="100%" height="100%" verticalGap="2">
   		<mx:VBox width="100%" height="100%"  paddingTop="4"  verticalGap="0" paddingRight="4" paddingLeft="4" paddingBottom="4">
		   <mx:HBox width="100%" horizontalGap="0" id="hbox1">
		       <mx:Text text="(1) Pick the level of visibility this experiment should have." id="labelApplication"/>
		       <mx:RadioButtonGroup id = "radioGroupSeqApp">       	
		       </mx:RadioButtonGroup>
		   </mx:HBox>
		   <mx:HBox paddingLeft="20" horizontalGap="0" width="100%">
		   	<mx:VBox verticalGap="0">
		   		<mx:RadioButtonGroup id="visibilityRadioGroup"/>
		   		<mx:RadioButton value="OWNER" label="Owner       (the submitter and the lab PI)" groupName="visibilityRadioGroup"  click="checkVisibilitySetupCompleteness();parentDocument.dirty.setDirty()"/>
		   		<mx:RadioButton value="MEM" selected="true" label="Members   (all members of the lab group)" groupName="visibilityRadioGroup"  click="checkVisibilitySetupCompleteness();parentDocument.dirty.setDirty()"/>
				<mx:HBox>
					<mx:RadioButton value="INST" selected="true" label="Institution  (all lab groups that are part of institution)" groupName="visibilityRadioGroup"  click="checkVisibilitySetupCompleteness();parentDocument.dirty.setDirty()" id="radioInstitutionVisibility" enabled="false"/>
					<mx:ComboBox width="210" dataProvider="{this.possibleInstitutions}" id="institutionCombo" labelField="@display"  editable="false" change="checkVisibilitySetupCompleteness()">			       	
					</mx:ComboBox>					
				</mx:HBox>
		   		<mx:RadioButton value="PUBLIC" label="Public        (anyone)" groupName="visibilityRadioGroup"  click="checkVisibilitySetupCompleteness();parentDocument.dirty.setDirty()"/>
		   		
		   	</mx:VBox>
		   </mx:HBox>
		   <mx:Spacer height="20"/>
		   <mx:VBox width="100%" height="100%" verticalGap="0">
		   	<mx:Text text="(2) Specify other individual collaborators allowed access to this experiment&#xa;"/>
		   	<mx:HBox width="100%" paddingLeft="20" horizontalAlign="left" horizontalGap="6" paddingBottom="4">
		   	 <mx:ComboBox width="300" dataProvider="{possibleCollaborators}" id="collaboratorCombo" labelField="@displayName">			       	
		   	 </mx:ComboBox>
		   		   <mx:Button 
		   		   	  enabled="{collaboratorCombo.selectedItem != null &amp;&amp; collaboratorCombo.selectedIndex > 0 ? true : false}" 
		   		   	  icon="@Embed(source='../../assets/add.png')" 
		   		   	  disabledIcon="@Embed(source='../../assets/add_disable.png')"
		   		   	  click="addCollaborator()" 
		   		   	  width="25">
		   		   </mx:Button>
		   		   <mx:Button  
		   		   	icon="@Embed(source='../../assets/delete.png')" 
		   		   	disabledIcon="@Embed(source='../../assets/delete_disable.png')" 
		   		   	enabled="{collaboratorGrid.selectedItem != null}" 
		   		   	click="removeCollaborator()" width="25"/>
		   	</mx:HBox>
		   	<mx:HBox paddingLeft="20" width="100%" height="100%">
			   	<mx:DataGrid id="collaboratorGrid" width="100%" dataProvider="{collaborators}" height="100%" showHeaders="false">
			   	      <mx:columns>
			   	          <mx:DataGridColumn dataField="@displayName" headerText="Name"/>
		   		      </mx:columns>
		   	  	</mx:DataGrid>		   		
		   	</mx:HBox>
		   </mx:VBox>
		   	 


		</mx:VBox>
		
	</mx:VBox>
	<mx:VBox  horizontalAlign="center" paddingLeft="4" id="vbox2" right="0" top="0">
	 <mx:TextArea styleName="instructionBox" width="300" wordWrap="true" height="80" id="textarea1">
	 <mx:htmlText><![CDATA[Instructions<br>  1.  Provide requested information or select appropriate<br>       dropdown options for each line item below.<br>  2.  After completing all line items, click the 'Next' button<br>       at the bottom of the page to proceed.]]></mx:htmlText>
	 </mx:TextArea>
	</mx:VBox>
	
  </mx:Canvas>


	
</mx:Canvas>
