<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas label="Request setup" width="100%" height="100%" xmlns:views="*.views" xmlns:mx="http://www.adobe.com/2006/mxml">
   

   	
   <mx:HTTPService  
    id="getLab" 
    url="GetLab.gx"
    destination="getLab"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetLab(event)"
    fault="parentApplication.onFailHttpRequest('Failed to get group', event)"
    method="POST"
    useProxy="false">
    <mx:request>
    	<idLab>{this.labCombo.selectedItem.@idLab}</idLab>
    </mx:request>
   </mx:HTTPService>
  
   <mx:HTTPService  
    id="getNewProject" 
    url="GetProject.gx"
    destination="getProject"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetNewProject(event)"
    fault="parentApplication.onFailHttpRequest('Failed to get new project', event)"
    method="POST"
    useProxy="false">
    <mx:request>
   		<idProject>0</idProject>    	
    </mx:request>
  </mx:HTTPService>

  <mx:HTTPService  
    id="getProject" 
    url="GetProject.gx"
    destination="getProject"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetProject(event)"
    fault="parentApplication.onFailHttpRequest('Failed to get project', event)"
    method="POST"
    useProxy="false">
  </mx:HTTPService>
  
    <mx:HTTPService  
    id="getProjectForEdit" 
    url="GetProject.gx"
    destination="getProjectForEdit"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetProjectForEdit(event)"
    fault="parentApplication.onFailHttpRequest('Failed to get project to edit', event)"
    method="POST"
    useProxy="false">
  </mx:HTTPService>
  
  <mx:HTTPService  
    id="getProjectRequestList" 
    url="GetProjectRequestList.gx"
    destination="getProjectRequestList"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetProjectRequestList(event)"
    fault="parentApplication.onFailHttpRequest('Failed to get project request list', event)"
    method="POST"
    useProxy="false">
    <mx:request>
            <idLab>{labCombo.selectedItem.@idLab}</idLab> 
            <showSamples>N</showSamples>
            <showCategory>N</showCategory>
            <showMyLabsAlways>N</showMyLabsAlways>
            <listKind>ProjectRequestCloneList</listKind>
    </mx:request>
   </mx:HTTPService>
   
<mx:Script>

	<![CDATA[
		import mx.controls.Alert;
		import mx.rpc.events.ResultEvent;
		import mx.managers.PopUpManager;
		import mx.collections.Sort;
		import mx.collections.XMLListCollection;
		import views.experiment.RequestCloneWindow;
		import views.experiment.ProjectDetailWindow;

        [Bindable]
        private var lab:Object = null;
        
        [Bindable]
        private var appUsers:XMLListCollection;
        private var appUserSort:Sort;
		
        public var idAppUser:Object = '';

		public var projectDetailWindow:ProjectDetailWindow;
		public var selectedIdProject:Object;
		
		private var requestCloneWindow:RequestCloneWindow;
		
		public function checkSecurity():void {
			if (parentApplication.hasPermission("canWriteAnyObject")) {
				this.appUserContainer.visible = true;
				idAppUser = '';
			} else {
				this.appUserContainer.visible = false;
				idAppUser = parentApplication.getIdAppUser();
				if (labCombo.dataProvider.length == 2) {
					labCombo.selectedIndex = 1;
				}
			}			
		}
		
		public function selectDefaultLab():void {
			if (parentApplication.hasPermission("canWriteAnyObject")) {
				labCombo.selectedIndex = 0;
			} else {
				if (labCombo.dataProvider.length == 2) {
					labCombo.selectedIndex = 1;
					getLab.send();							
				}
			}			
		}
		
		public function getRequestCategory():Object {
			var requestCategory:Object = parentApplication.dictionaryManager.getEntry('hci.gnomex.model.RequestCategory', requestTypeGroup.selectedValue);
			return requestCategory;			 
		}
		
				

		private function showNewProjectWindow():void {
			if (idAppUser == '' || idAppUser == null) {
				Alert.show('Please select the user submitting the request'); 
			} else {
				getNewProject.send();
			}		
		}
		private function filterBillingAccount(item:Object):Boolean {

        	if (item.@isActive == 'N') {
        		return false;
        	}
        	return true;
		}
		private function showEditProjectWindow():void {
			selectedIdProject = this.projectCombo.selectedItem.@idProject;
			var params:Object = new Object();
			params.idProject = this.projectCombo.selectedItem.@idProject;
			getProjectForEdit.send(params);			
		}
	
		private function onGetNewProject(event:ResultEvent):void {
			if (getNewProject.lastResult.name() == "OpenProjectList") {
				 parentApplication.navExperimentView.selectedProject = getNewProject.lastResult.Project.(@idProject == 0);
				 parentApplication.navExperimentView.selectedProject.@idAppUser = idAppUser;
				 parentApplication.navExperimentView.selectedProject.@idLab = this.labCombo.selectedItem.@idLab;

				 this.projectDetailWindow = ProjectDetailWindow(PopUpManager.createPopUp(this, ProjectDetailWindow, true));
				 this.projectDetailWindow.projectDetailView.fromSubmitRequestWindow = true;
				 this.projectDetailWindow.projectDetailView.experimentDesignEntries.refresh();
				 this.projectDetailWindow.projectDetailView.experimentFactorEntries.refresh();
				 this.projectDetailWindow.projectDetailView.setupDataListeners();
				 
				 this.projectDetailWindow.labCombo.selectedItem = this.labCombo.selectedItem;
				 this.projectDetailWindow.labCombo.enabled = false;
				 
				 PopUpManager.centerPopUp(this.projectDetailWindow);		
				
			} else {
				mx.controls.Alert.show(getNewProject.lastResult..ACTMESSAGE.@TEXT, "Get new project failed");
			}
		}
		
		private function onGetProjectForEdit(event:ResultEvent):void {
			if (getProjectForEdit.lastResult.name() == "OpenProjectList") {
				 parentApplication.navExperimentView.selectedProject = getProjectForEdit.lastResult.Project.(@idProject == projectCombo.selectedItem.@idProject);

				 this.projectDetailWindow = ProjectDetailWindow(PopUpManager.createPopUp(this, ProjectDetailWindow, true));
				 this.projectDetailWindow.title = "Edit Project";
				 this.projectDetailWindow.projectDetailView.fromSubmitRequestWindow = true;
				 this.projectDetailWindow.projectDetailView.experimentDesignEntries.refresh();
				 this.projectDetailWindow.projectDetailView.experimentFactorEntries.refresh();
				 this.projectDetailWindow.projectDetailView.setupDataListeners();
				 
				 this.projectDetailWindow.labCombo.selectedItem = this.labCombo.selectedItem;
				 this.projectDetailWindow.labCombo.enabled = false;
				 
				 PopUpManager.centerPopUp(this.projectDetailWindow);		
				
			} else {
				mx.controls.Alert.show(getNewProject.lastResult..ACTMESSAGE.@TEXT, "Get project for edit failed");
			}
			
		}

		
		private function onGetProject(event:ResultEvent):void {
			var newProject:Object = getProject.lastResult..Project.(@idProject == selectedIdProject);
			
			// If this is an existing project we just editted, remove the old one from the dropdown.
			//  We will add the refreshed one below.
			var existingProject:Object = null;
			var x:int = 0;
			for each(var project:Object in parentApplication.filteredProjectListForSubmitRequests) {
				if (project.@idProject == newProject.@idProject) {
					parentApplication.filteredProjectListForSubmitRequests.removeItemAt(x);
					parentApplication.filteredProjectListForSubmitRequests.refresh();
					break;
				}
				x++;
			}
			
			parentApplication.filteredProjectListForSubmitRequests.addItem(newProject);
			parentApplication.filteredProjectListForSubmitRequests.refresh();
			this.projectCombo.selectedItem = newProject;
			checkSetupCompleteness();
		}
				
		public function onProjectAdded(idProject:Object):void {
			selectedIdProject = idProject;
			var params:Object = new Object();
			params.idProject = idProject;
			getProject.send(params);
		}
		

		
		
		private function getMembersOfLab():void {
			if (parentApplication.hasPermission("canWriteAnyObject") && 
			    this.labCombo.selectedItem.@idLab != '') {
			    idAppUser = null;
			}
			
			if (this.labCombo.selectedItem.@idLab != null) {
				getLab.send();				
			}
		}
		private function onGetLab(event:ResultEvent):void {			
			lab = getLab.lastResult..Lab.(@idLab == labCombo.selectedItem.@idLab);
			var emptyNode:XML = <AppUser idAppUser='' displayName=''/>;
			appUsers = new XMLListCollection(lab.members.AppUser);
			for each (var mgr:Object in lab.managers.AppUser) {
				if (!appUsers.contains(mgr)) {
					appUsers.addItem(mgr);				
				}
			}
			appUsers.addItemAt(emptyNode, 0);
			
			appUserSort = new Sort();
	        appUserSort.compareFunction = this.sortAppUsers;
	        appUsers.sort = appUserSort;
	        appUsers.refresh();
	        
	        this.appUserCombo.selectedIndex = 0;

			billingAccounts = new XMLListCollection(lab.billingAccounts.BillingAccount);
	        billingAccounts.filterFunction = this.filterBillingAccount;
	        billingAccounts.refresh();
	        if (billingAccounts.length == 1) {
	        	this.billingAccountCombo.selectedIndex = 0;	        	
	        } 
	        
	        parentApplication.filteredProjectListForSubmitRequests.refresh();

		}

        private function sortAppUsers(obj1:Object, obj2:Object, fields:Array=null):int {
			if (obj1 == null && obj2 == null) {
				return 0;
			} else if (obj1 == null) {
				return 1;
			} else if (obj2 == null) {
				return -1;
			} else {
				var display1:String = obj1.@displayName;
				var display2:String = obj2.@displayName;
				
				if (display1 < display2) {
					return -1;
				} else if (display1 > display2) {
					return 1;
				} else {
					return 0;
				}
				
			}
		}			

	
		private function checkSetupCompleteness():void {
        	var isComplete:Boolean = false;
        	if (parentDocument.request != null && parentDocument.request.@idRequest != '0') {
        		isComplete = true;
        	} else if (idAppUser != null &&  idAppUser != '' &&
        	    this.requestTypeGroup.selectedValue != null &&
        	    this.labCombo.selectedItem != null && this.labCombo.selectedItem.@idLab != '' &&
        	    this.billingAccountCombo.selectedItem != null && 
        	    this.projectCombo.selectedItem != null && this.projectCombo.selectedItem.@idProject != '') {
        	    isComplete = true;
        	    	
        	} 
    		parentDocument.sampleSetupView.enabled = isComplete;
    		parentDocument.enableNextButtons();
    		if (parentDocument.theTab.contains(parentDocument.annotationView)) {
        		parentDocument.annotationView.enabled = isComplete;        			
    		}

    		
    		callLater(postSetupCompleteness, [isComplete]);
    		
    		
        }
        
        private function postSetupCompleteness(isComplete:Boolean):void {
    		if (!isComplete) {
	    		parentDocument.samplesView.enabled = false;
	        	if (parentDocument.theTab.contains(parentDocument.hybSetupView)) {
		        	parentDocument.hybSetupView.enabled = false;
	        	} 
	        	if (parentDocument.theTab.contains(parentDocument.hybsView)) {
		        	parentDocument.hybsView.enabled = false;
	        	} 
	        	parentDocument.confirmView.enabled = false;
    		} else {
    			parentDocument.sampleSetupView.checkSampleSetupCompleteness();
    			parentDocument.samplesView.checkSamplesCompleteness();
    			parentDocument.hybSetupView.checkHybSetupCompleteness();
    			parentDocument.hybsView.checkHybsCompleteness();
    		}
        	
        }

		private function onGetProjectRequestList(event:ResultEvent):void {
			
			this.requestCloneWindow = RequestCloneWindow(PopUpManager.createPopUp(this, RequestCloneWindow, true));
			PopUpManager.centerPopUp(requestCloneWindow);
			requestCloneWindow.expandAllNodes();
		}
        

	]]>
</mx:Script>
	<mx:XMLListCollection id="billingAccounts"  filterFunction="filterBillingAccount"/>
	
	<mx:NumberValidator id="labValidator"
        source="{this.labCombo}"
        lowerThanMinError="This field is required."
        property="selectedIndex"
        minValue="1" /> 
     <mx:NumberValidator id="appUserValidator"
        source="{this.appUserCombo}"
        lowerThanMinError="This field is required."
        property="selectedIndex"
        minValue="1" /> 
     <mx:NumberValidator id="billingAccountValidator"
        source="{this.billingAccountCombo}"
        lowerThanMinError="This field is required."
        property="selectedIndex"
        minValue="0" />         
     <mx:NumberValidator id="projectValidator"
        source="{this.projectCombo}"
        lowerThanMinError="This field is required."
        property="selectedIndex"
        minValue="1" />           
          
		<mx:VBox width="100%" height="100%" verticalGap="32" paddingTop="10">
			<mx:HBox width="100%" horizontalGap="0">
				<mx:Label text="(1) Verify your lab:" width="170"/>
				<mx:ComboBox dataProvider="{parentApplication.promptedSubmitRequestLabList}" 
					selectedIndex="-1" labelField="@name" 
					width="300"
					 change="parentApplication.filteredProjectListForSubmitRequests.refresh();projectCombo.selectedIndex = -1;checkSetupCompleteness();getMembersOfLab();" id="labCombo">
				</mx:ComboBox>
				<mx:HBox id="appUserContainer" visible="true" paddingLeft="12" horizontalGap="0" width="100%">						    
					<mx:Label text="User submitting request:"/>
					<mx:ComboBox dataProvider="{appUsers}" 
						selectedIndex="-1" labelField="@displayName" 
					    id="appUserCombo" width="200">
						<mx:change>{idAppUser = appUserCombo.selectedItem.@idAppUser;checkSetupCompleteness()}</mx:change>
					</mx:ComboBox>
				</mx:HBox>
			</mx:HBox>
			<mx:VBox width="100%" verticalGap="0"> 
				<mx:HBox width="100%" horizontalGap="0">
					<mx:Text  width="170" >
					  <mx:htmlText>
					  	<![CDATA[(2) Pick the account to be <br> billed:]]>
					  </mx:htmlText>
					</mx:Text>
					<mx:ComboBox labelField="@accountName" width="430" id="billingAccountCombo" prompt=" " change="checkSetupCompleteness()">
						<mx:dataProvider>{billingAccounts}</mx:dataProvider>
					</mx:ComboBox>
				</mx:HBox>
				<mx:HBox width="100%">
				    <mx:Spacer width="160"/>
				    <mx:Text width="100%">
				        <mx:htmlText><![CDATA[ If billing account is inactive, please download the work authorization form below.<br> Forward the completed form to the Microarray Core Facility (HCI room 3363; Fax 585-0900)]]></mx:htmlText>
					</mx:Text>
					
				</mx:HBox>
				<mx:HBox width="100%">
				    <mx:Spacer width="160"/>
					<mx:LinkButton label="Work authorization form (pdf)" useHandCursor="true" textDecoration="underline" color="#0000ff"> 
						<mx:click>navigateToURL(new URLRequest('doc/microarray_core_work_authorization_form.pdf'), '_blank');</mx:click>
					</mx:LinkButton>
					<mx:LinkButton label="Work authorization form (Microsoft work doc)" textDecoration="underline" useHandCursor="true" color="#0000ff">
						<mx:click>navigateToURL(new URLRequest('doc/microarray_core_work_authorization_form.doc'), '_blank');</mx:click>
					</mx:LinkButton>
				</mx:HBox>
				
			</mx:VBox>
			<mx:HBox width="100%" horizontalGap="0">
			<mx:Label text="(3) Select a service:" width="170"/>
			<mx:HBox id="requestTypeBox" horizontalGap="8" styleName="requiredBox" paddingLeft="2" paddingTop="1" paddingRight="1" paddingBottom="0">
				<mx:VBox verticalGap="2" paddingRight="2" paddingBottom="2">
				    <mx:HBox width="100%" horizontalAlign="center">
				     <mx:Image source="assets/microarray_black.png" />						    	
				    </mx:HBox>
				    <mx:RadioButtonGroup id="requestTypeGroup" />
				    <mx:HBox>
				    <mx:RadioButton groupName="requestTypeGroup" label="Agilent Microarray" value="AGIL" click="parentDocument.setRequestCategoryName();checkSetupCompleteness();" change="checkSetupCompleteness()" id="requestRadioAgilent" width="100%"/>							
				    </mx:HBox>
				</mx:VBox>
				<mx:VBox verticalGap="2" paddingRight="2" paddingBottom="2">
				    <mx:HBox width="100%" horizontalAlign="center">
				     <mx:Image source="assets/microarray_black.png" />						    	
				    </mx:HBox>
				    <mx:HBox>
				    <mx:RadioButton groupName="requestTypeGroup" label="Affymetrix Microarray" value="AFFY" click="parentDocument.setRequestCategoryName();checkSetupCompleteness();" change="checkSetupCompleteness()" id="requestRadioAffy" width="100%"/>							
				    </mx:HBox>
				</mx:VBox>
				<mx:VBox verticalGap="2" paddingLeft="2" paddingRight="2" paddingBottom="2">									
				    <mx:HBox width="100%" horizontalAlign="center">
				    	<mx:Image source="assets/chart_curve.png"/>
				    </mx:HBox>
				    <mx:RadioButton groupName="requestTypeGroup" label="Sample Quality" value="QC" click="parentDocument.setRequestCategoryName();checkSetupCompleteness();" change="checkSetupCompleteness()" id="requestRadioQC" paddingBottom="0"/>
				    <mx:HBox paddingTop="0">
				    	<mx:Spacer width="10"/>												
				    </mx:HBox>						
				</mx:VBox>
				<mx:VBox verticalGap="2" paddingLeft="2" paddingRight="2" paddingBottom="2">
				    <mx:HBox width="100%" horizontalAlign="center">
				     <mx:Image source="assets/solexa.png"/>						    	
				    </mx:HBox>
					<mx:RadioButton groupName="requestTypeGroup" label="Illumina Sequencing" value="SOLEXA" click="parentDocument.setRequestCategoryName();checkSetupCompleteness();" change="checkSetupCompleteness()" id="requestRadioSolexa"/>																							
				</mx:VBox>
			</mx:HBox>
			</mx:HBox>
			<mx:HBox width="100%" horizontalGap="0">
				<mx:Text width="170" height="50">
					<mx:htmlText>(4) Pick a project folder for organizing this request:</mx:htmlText>
				</mx:Text>
				<mx:HBox verticalGap="2">
				    <mx:VBox verticalGap="2" paddingRight="20">
					<mx:RadioButtonGroup id="projectRadioGroup"/>
					<mx:RadioButton label="New project" groupName="projectRadioGroup" click="{showNewProjectWindow()}"/>
					<mx:RadioButton label="Existing project" groupName="projectRadioGroup" selected="true"/>
				    	
				    </mx:VBox>
					<mx:HBox  height="100%" width="100%" horizontalAlign="right" verticalAlign="middle" horizontalGap="2">
					<mx:ComboBox dataProvider="{parentApplication.filteredProjectListForSubmitRequests}" labelField="@name" width="300" id="projectCombo" change="{checkSetupCompleteness()}">
					</mx:ComboBox>
						<mx:LinkButton id="editProjectButton" label="Edit..." click="showEditProjectWindow()" textDecoration="underline" styleName="formLinkButton">
							<mx:enabled>{projectCombo.selectedItem != null &amp;&amp; projectCombo.selectedItem.@idProject != &quot;&quot;}</mx:enabled>
						</mx:LinkButton>
					</mx:HBox>					
				</mx:HBox>
			</mx:HBox>
			<mx:VBox width="100%" verticalGap="1">
			</mx:VBox>
			
		</mx:VBox>

</mx:Canvas>
