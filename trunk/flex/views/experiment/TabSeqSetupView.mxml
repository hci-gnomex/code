<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas label="Seq application" 
	xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:util="views.util.*" 
	 width="100%" height="100%" show="init()" >
	<mx:states>
		<mx:State name="EditState">
			<mx:RemoveChild target="{hbox1}"/>
			<mx:SetProperty name="enabled" value="true"/>
		</mx:State>
	</mx:states>
<mx:Script>
	<![CDATA[
		import hci.flex.controls.CheckBox;
		
		import mx.collections.ArrayCollection;
		import mx.collections.XMLListCollection;
		import mx.controls.RadioButton;
		import mx.controls.Spacer;
		import mx.events.ListEvent;
		
		import views.renderers.CheckBoxIsSelectedChipType;
	
		private var validNumberOfSamples:Boolean = true;
		private var validConcentration:Boolean = true;
		private var application:Object = null;
		
		[Bindable]
		private var meanInsertSizes:ArrayCollection = null;

		private var codeRequestCategoryInitted:String = "";
		private var seqPrepByCoreInitted:String = "NotInitted";
		
		[Bindable]
		private var themeList:XMLListCollection = null;
		
		public function init():void {
			checkSecurity();
			
			// We don't show seq apps on edit window
			if (this.currentState == "EditState") {
				return;
			}
			
			var localPrepByCore:String = "";
			if (parentDocument.samples.length > 0) {
				localPrepByCore = parentDocument.samples.getItemAt(0).@seqPrepByCore;
			}
			// Only initialize once.
			if (themeList != null && codeRequestCategoryInitted == parentDocument.getRequestCategory().@codeRequestCategory
				&& seqPrepByCoreInitted == localPrepByCore) {
				return;
			}
			
			this.codeRequestCategoryInitted = parentDocument.getRequestCategory().@codeRequestCategory;
			this.seqPrepByCoreInitted = localPrepByCore;
			
			parentDocument.filteredAppList.refresh();
			
			// Map the apps by theme
			this.applicationThemeRepeater.dataProvider = null;
			var themeMap:Array = new Array();
			for each(var item:Object in parentDocument.filteredAppList) {
				var de:XMLList = parentApplication.dictionaryManager.getEntry("hci.gnomex.model.ApplicationTheme", item.@idApplicationTheme);
				if (de.length() >= 1) {
					themeMap[item.@idApplicationTheme.toString()] = de[0];
				}
			}
			themeList = new XMLListCollection();
			for each(var theme:Object in themeMap) {
				themeList.addItem(theme);
			}
			this.applicationThemeRepeater.dataProvider = themeList;
			themeList.refresh();
			this.chosenThemeLabel.text = "";
			libraryDesign.visible = false;
			libraryDesign.includeInLayout = false;

			seqAppBox.styleName="normalBox";
			
			checkSeqAppSetupCompleteness();
		}
		
		public function checkSecurity():void {
		}
		
		private function onSeqAppRadioClick():void {
			pickSeqApp();
		}
	
	 

		public function checkSeqAppSetupCompleteness():Boolean {
			var isComplete:Boolean = false;
			if (parentDocument.isEditState() && parentDocument.request.@captureLibDesignId != "") {
				isComplete = true;
			} else if (parentDocument.isSolexaState() || parentDocument.isSolexaAmendState() || parentDocument.isAmendState()) {
				if (this.radioGroupSeqApp.selectedValue != null && this.radioGroupSeqApp.selectedValue != '') {
					
					if (libraryDesign.visible) {
						
						// If the capture design lib id is visible, it is required, so
						// make sure it has been filled in.
						if (parentDocument.request.@captureLibDesignId != "") {
							isComplete = true;
						}
					} else {
						
						// If neither insert ranges or design lib id is visible, we have
						// passed all of the required field checks already.
						isComplete = true;
						
					}
				}
			} 
			
			if (this.currentState != "EditState") {
				parentDocument.samplesView.enabled = isComplete; 
			}
			
			
			if (this.currentState != "EditState" && parentDocument.theTab.contains(parentDocument.annotationView)) {
				parentDocument.annotationView.enabled = isComplete;        			
			}
			
			parentDocument.enableNextButtons();
			
			callLater(postSeqAppSetupCompleteness, [isComplete]);
			
			return isComplete;
			
		}
		
        private function postSeqAppSetupCompleteness(isComplete:Boolean):void {
	    		
	    	if (!isComplete) {
	        	if (parentDocument.theTab.contains(parentDocument.samplesView)) {
		        	parentDocument.samplesView.enabled = false;
	        	}
				if (parentDocument.theTab.contains(parentDocument.annotationView)) {
					parentDocument.annotationView.enabled = false;
				}
	        	parentDocument.confirmView.enabled = false;
    		} else {
    			if (parentDocument.theTab.contains(parentDocument.samplesView)) {
		    		parentDocument.samplesView.checkSamplesCompleteness();
		    	}
    		}
        	
        }

		private function pickSeqApp():void {
			if (this.radioGroupSeqApp.selectedValue != null) {
				this.seqAppBox.styleName = 'normalBox';
				application = parentApplication.dictionaryManager.getEntry('hci.gnomex.model.Application', radioGroupSeqApp.selectedValue);
				if (application != null && application is XMLList) {
					this.parentDocument.applicationName = application[0].@display;
					this.parentDocument.codeApplication = application[0].@codeApplication;
					if(application[0].@hasCaptureLibDesign == 'Y'){ //If it is sure select we need to show the library capture id input box
						libraryDesign.visible = true;
						libraryDesign.includeInLayout = true;
					}
					else{
						libraryDesign.visible = false;
						libraryDesign.includeInLayout = false;
						designID.text = "";
						libraryDesign.styleName = "requiredBox";
						parentDocument.request.@captureLibDesignId = "";
					}
				} else if (application != null && application is XML) {
					this.parentDocument.applicationName = application.@display;
					this.parentDocument.codeApplication = application.@codeApplication;
				}
			} else {
				this.seqAppBox.styleName = 'requiredBox';
				this.parentDocument.applicationName = '';
				this.parentDocument.codeApplication = '';	
			}
			
			this.checkSeqAppSetupCompleteness();
		}
		
		
		private function propagateDesign():void{
			libraryDesign.styleName = "requiredBox";
	
			if(designID.text != "" || designID.text != null){
				parentDocument.request.@captureLibDesignId = designID.text;
				libraryDesign.styleName = "undefined";
			}
			
			checkSeqAppSetupCompleteness();
		}
		
		private function chooseTheme(applicationTheme:Object):void {
			chosenThemeLabel.text = applicationTheme.@display.toString();
			var capLibBoxSet:Boolean = false;
			for(var i:int = 0; i < seqAppBox.numChildren; i++) {
				var child:Object = seqAppBox.getChildAt(i);
				if (child is RadioButton) {
					var radio:RadioButton = RadioButton(child);
					var app:Object = parentApplication.dictionaryManager.getEntry('hci.gnomex.model.Application', radio.value);
					if (app != null) {
						if (app.@idApplicationTheme == applicationTheme.@value) {
							radio.visible = true;
							radio.includeInLayout = true;
							seqAppBox.validateNow();
							if(app.@hasCaptureLibDesign == 'Y' && !capLibBoxSet){
								designSpacer.height = radio.y;
								designSpacer.validateNow();
								capLibBoxSet = true;
							}
						} else {
							radio.visible = false;
							radio.includeInLayout = false;
						}
					}
				}
			}
			
			pickSeqApp();
		}
	]]>
</mx:Script>

  <mx:XMLListCollection id="seqLibTreatments" source="{parentDocument.request.SeqLibTreatmentEntries.SeqLibTreatment}"/>
  <mx:Canvas width="100%" height="100%">
    <mx:VBox id="topBox" width="100%" verticalGap="0">
		<mx:Text text="Select a sequencing application."  id="labelApplication"/>
		<mx:Tile width="100%" direction="horizontal" paddingLeft="0" paddingRight="0" paddingTop="0" paddingBottom="0" >
			<mx:Repeater id="applicationThemeRepeater" dataProvider="{themeList}">
				<mx:LinkButton label="{applicationThemeRepeater.currentItem.@display}" click="chooseTheme(event.currentTarget.getRepeaterItem())" fontWeight="normal" textDecoration="underline" enabled="true" visible="true" />
			</mx:Repeater>
		</mx:Tile>
		<mx:HBox id="mainBox" width="100%" height="100%" verticalGap="2" paddingTop="0">
	   		<mx:VBox height="100%" paddingTop="2"  verticalGap="2" id="sampleSetupContainer" enabled="true" >
			   	<mx:HBox horizontalGap="0" id="hbox1" paddingLeft="12">
			       <mx:RadioButtonGroup id = "radioGroupSeqApp">       	
			       </mx:RadioButtonGroup> 
			       <mx:VBox height="100%" verticalGap="0" paddingLeft="2" paddingRight="2" paddingBottom="0" paddingTop="0" styleName="requiredBox" id="seqAppBox">
					   <mx:Label text="" id="chosenThemeLabel" width="400" fontWeight="bold" />
					   <mx:Repeater id="applicationRepeater" dataProvider="{parentDocument.filteredAppList}">
						   <mx:RadioButton id="applicationButton" groupName="radioGroupSeqApp" 
										   label="{applicationRepeater.currentItem.@display}" 
										   value="{applicationRepeater.currentItem.@value}" 
										   click="{onSeqAppRadioClick()}" fontSize="11" paddingTop="0" paddingBottom="0"
										   visible = "false" includeInLayout="false"/>							
					   </mx:Repeater>
			       </mx:VBox>
			   	</mx:HBox>
			</mx:VBox>	
			<mx:VBox  visible="{libraryDesign.visible}" includeInLayout="{libraryDesign.visible}"  height="100%"  paddingTop="2">
				<mx:Spacer id="designSpacer" includeInLayout="{libraryDesign.visible}"/>
				<mx:VBox verticalGap="0" id="libraryDesign" visible="false" includeInLayout="false" paddingTop="10" paddingLeft="10" styleName="requiredBox">
					<mx:HBox paddingBottom="10" paddingRight="10">
						<mx:Label text="Capture Library Design ID: " id="designIDLabel" />
						<mx:TextInput id="designID" change="propagateDesign()"/>
					</mx:HBox>
				</mx:VBox>
			</mx:VBox>
		</mx:HBox>
	</mx:VBox>
	
 </mx:Canvas>
</mx:Canvas>