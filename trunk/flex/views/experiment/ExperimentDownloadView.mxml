<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" xmlns:views="views.*" xmlns:util="views.util.*">

 

   <mx:HTTPService  
    id="getExpandedFileList" 
    url="GetExpandedFileList.gx"
    destination="getExpandedFileList"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetExpandedFileList(event)"
	fault="parentApplication.onFailHttpRequest('Failed to get expanded file list', event)"
    method="POST"
    useProxy="false">
    <mx:request>
    	<resultKeys>{resultKeys}</resultKeys>
    </mx:request>
  </mx:HTTPService>

   <mx:HTTPService  
    id="cacheFileDownloadList" 
    url="CacheFileDownloadList.gx"
    destination="cacheFileDownloadList"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onCacheFileDownloadList(event)"
	fault="parentApplication.onFailHttpRequest('Failed to get cache file download list', event)"
    method="POST"
    useProxy="false">
    <mx:request>
    	<fileDescriptorXMLString>{selectedFileList.toXMLString()}</fileDescriptorXMLString>
    </mx:request>
  </mx:HTTPService>
  
    
    <mx:HTTPService  
    id="getRequestDownloadList" 
    url="GetRequestDownloadList.gx"
    destination="getRequestDownloadList"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetRequestDownloadList(event)"
	fault="parentApplication.onFailHttpRequest('Failed to get request download list', event)"
    method="POST"
    useProxy="false">
    </mx:HTTPService >	
    
    <mx:HTTPService  
    id="getDownloadEstimatedSize" 
    url="GetDownloadEstimatedSize.gx"
    destination="getDownloadEstimatedSize"
    resultFormat="e4x"
    showBusyCursor="true"
    result="onGetDownloadEstimatedSize(event)"
	fault="parentApplication.onFailHttpRequest('Failed to get download estimated size', event)"
    method="POST"
    useProxy="false">
    <mx:request>
    	<resultKeys>{resultKeys}</resultKeys>
    </mx:request>
    </mx:HTTPService>
  

 <mx:Script>
 <![CDATA[
 	import views.experiment.DownloadProgressView;
 	import mx.formatters.DateFormatter;
    import mx.rpc.events.ResultEvent;
 	import flash.display.Sprite;
    import flash.net.FileReference;
    import flash.net.URLRequest;
    import flash.net.URLRequestMethod;
    import flash.net.URLVariables;
    import mx.managers.PopUpManager;
    import mx.events.ListEvent;
   
	
 	[Bindable]
    private var rowCountMessage:String = new String();
 	[Bindable]
    private var fileCountMessage:String = new String();
    
    [Bindable]
    private var selectedFileList:XMLListCollection;
    
    private var estimatedDownloadSize:Number;
    
    private const DOWNLOAD_FOLDERS_URL:String = "DownloadResultsServlet.gx"; 
    private const DOWNLOAD_FILES_URL:String   = "DownloadFileServlet.gx"; 
    
    [Bindable]
    public var resultKeys:String;  
    
    private var dateFormatter:DateFormatter = new DateFormatter();
        
    private function onGetRequestDownloadList(event:ResultEvent): void { 
    	parentDocument.filterList();
    		
    }
    private function getSelectedFolders():void {
		resultKeys = "";
    	for(var i:Number = 0; i < downloadList.length; i++) {
    		if (downloadList[i].@isSelected != null && downloadList[i].@isSelected.toString() == "true") {
        		resultKeys += downloadList[i].@key + ":";
      		}
        }     	
    }
    
    public function downloadFolders():void { 
    	getSelectedFolders();
    	getDownloadEstimatedSize.send();
    	
 	}
            
    public function downloadFoldersAndShowProgress():void { 
    	
        var parms:String = "resultKeys="+ resultKeys;
    	var progressWindow:DownloadProgressView = new DownloadProgressView();
    	progressWindow.init(this, this.DOWNLOAD_FOLDERS_URL, parms, parentDocument.downloadFoldersButton, estimatedDownloadSize);
    	
    	
 	}
 	
 	public function downloadFiles():void {
		var selectedFiles:XMLList = getExpandedFileList.lastResult..FileDescriptor.(@isSelected == "true");        	
    	selectedFileList = new XMLListCollection(selectedFiles);
    	estimatedDownloadSize = 0;
    	for each (var item:Object in selectedFileList) {
    		var fileSize:Number = item.@fileSize;
			estimatedDownloadSize += fileSize;
		}
		estimatedDownloadSize = estimatedDownloadSize / 2.5;
    	
    	cacheFileDownloadList.send();
 	}
 	
 	
 	
 	public function exploreFolders():void {
 		getSelectedFolders();
 		
 		getExpandedFileList.send();
 		exploreView.enabled = true;
 	}
 	
 	private function getRequestNumber(item:Object, col:int):String {
 		if (item.@showRequestNumber == "Y") {
	    	return item.@requestNumber;
 		} else {
 			return "";
 		}
    }
    private function getDirectoryName(item:Object, col:int):String {
 		if (item.@showDirectoryName == "Y") {
	    	return item.@directoryName;
 		} else {
 			return "";
 		}
    }
    
    private function getFolderName(item:Object, col:int):String {
    	if (item.@hybNumber != null && item.@hybNumber != '') {
	    	return item.@hybNumber + ' - ' + item.@results;		
    	} else {
    		return item.@results;
    	}
    }
    

	public function setFileCount():void {
		fileCountMessage = expandedFileList.length + " files found.";
	}

    
    public function setResultsCount():void {
    	rowCountMessage = downloadList.length + " folders found.";
    }
    
    private function getGridRowNumber(item:Object,col:int):String
    {
       var x:int = downloadList.getItemIndex(item) + 1;
       return String(x);
    } 
    
    private function onGetExpandedFileList(event:ResultEvent):void {
    	setFileCount();
    	theTab.selectedIndex = 1;
    }
    
    private function onGetDownloadEstimatedSize(event:ResultEvent):void {
    	estimatedDownloadSize = getDownloadEstimatedSize.lastResult.@size;
    	downloadFoldersAndShowProgress();
    }
    
    private function onCacheFileDownloadList(event:ResultEvent):void {
    	var progressWindow:DownloadProgressView = new DownloadProgressView();
    	progressWindow.init(this, this.DOWNLOAD_FILES_URL, null, parentDocument.downloadFilesButton, estimatedDownloadSize);
    }
    
    private function onTabSwitch():void {
    	if (theTab.selectedChild == exploreView) {
    		exploreFolders();
    		parentDocument.buttonStack.selectedChild = parentDocument.downloadFilesButtonView;
    	} else {
    		parentDocument.buttonStack.selectedChild = parentDocument.downloadFoldersButtonView;    		
    	}
    }
    
   	private function toggleFolderCheck(event:ListEvent):void {
   		if (event.columnIndex == 0) {
   			return;
   		}
   		if (folderGrid.selectedItem.@isSelected == "true") {
			folderGrid.selectedItem.@isSelected = "false";
		} else {
			folderGrid.selectedItem.@isSelected = "true";
		}
	}

   	private function toggleFileCheck(event:ListEvent):void {
   		if (event.columnIndex == 0) {
   			return;
   		}
		if (fileGrid.selectedItem.@isSelected == "true") {
			fileGrid.selectedItem.@isSelected = "false";
		} else {
			fileGrid.selectedItem.@isSelected = "true";
		}
	}
    
 ]]>
 </mx:Script>
 
    <mx:XMLListCollection id="downloadList" source="{getRequestDownloadList.lastResult.RequestDownload}"/>
    <mx:XMLListCollection id="expandedFileList" source="{getExpandedFileList.lastResult.RequestDirectory.Directory.FileDescriptor}"/>
	
	<mx:VBox width="100%" height="100%" paddingBottom="4" paddingLeft="4" paddingRight="4" paddingTop="4">
	    <mx:LinkBar id="linkBar" styleName="formLinkBar" dataProvider="{theTab}"/>
		<mx:ViewStack id="theTab"  
			width="100%" height="100%" 
			change="onTabSwitch()" 
			>
			<mx:VBox id="folderView" 
				label="Folders" width="100%" height="100%" 
				paddingLeft="0" paddingRight="0" 
				paddingTop="0" paddingBottom="0" verticalGap="0">
		       <util:DataGridAlternatingGroup  
		       	 sortableColumns="false" id="folderGrid"
		       	dataProvider="{downloadList}"  
		       	width="100%" height="100%"
		       	  itemClick="toggleFolderCheck(event)">
		         <util:columns>
		            <mx:DataGridColumn headerText=" " 
		            	width="10" 
		            	editable="true"                        	
		            	dataField="@isSelected" 
		            	editorDataField="selected" sortable="false"
		            	itemRenderer="views.renderers.CheckBoxIsSelectedDownload">
		            </mx:DataGridColumn>
		            <mx:DataGridColumn minWidth="45" width="45" headerText="#">
		                <mx:itemRenderer>
		                    <mx:Component >
		                        <mx:HBox  horizontalGap="0" >
				                   <mx:Image   id="experimentImage"  
			                          	source="{(data.@showRequestNumber == 'Y' ? (data.@codeRequestCategory == 'QC' ? parentApplication.iconQC : (data.@codeRequestCategory == 'SOLEXA' ? parentApplication.iconSolexa : parentApplication.iconExperiment)) : '')}" >
 								   </mx:Image>
		                           <mx:Label id="requestNumber" text="{data.@showRequestNumber == 'Y' ? data.@requestNumber : ''}">
		                           </mx:Label>
		                        </mx:HBox>
		                    </mx:Component>
		                </mx:itemRenderer>
		            </mx:DataGridColumn> 
			       	<mx:DataGridColumn headerText="Folder" labelFunction="getFolderName"  width="150" dataField="@hybNumber"/>
			       	<mx:DataGridColumn headerText="Status" width="40" dataField="@status"/>
			       	<mx:DataGridColumn headerText="Date" width="42" dataField="@createDate"/>
			        <mx:DataGridColumn headerText="Requester" width="40" dataField="@idAppUser" labelFunction="parentApplication.getUserName"/>
			       	<mx:DataGridColumn headerText="Sample 1" width="50" dataField="@nameSample1"/>
			       	<mx:DataGridColumn headerText="Sample 2" width="50" dataField="@nameSample2"/>
		         </util:columns>
		       </util:DataGridAlternatingGroup>
			</mx:VBox>
			
			
			<mx:VBox id="exploreView" label="Explore Files" width="100%" height="100%" 
				enabled="true"
				verticalGap="0" paddingLeft="0" paddingRight="0">
			    <mx:HBox horizontalAlign="right" width="100%">
			      <mx:Label id="fileCountLabel" width="100%" text="{fileCountMessage}" textAlign="right"/>
			    </mx:HBox>
			    <mx:DataGrid 
			    	 width="100%" height="100%" 
	   	 			sortableColumns="false"	
			    	 dataProvider="{expandedFileList}" 
			    	  itemClick="toggleFileCheck(event)" id="fileGrid">
			       <mx:columns>
		            <mx:DataGridColumn headerText=" " 
		            	width="3" 
		            	editable="true"           sortable="false"              	
		            	dataField="@isSelected" 
		            	editorDataField="selected" 
		            	itemRenderer="views.renderers.CheckBoxIsSelectedDownload"/>
		            <mx:DataGridColumn width="14" headerText="#">
		                <mx:itemRenderer>
		                    <mx:Component >
		                        <mx:HBox  horizontalGap="0" >
		                          <mx:Image id="experimentImage"  
			                          	source="{(data.@showRequestNumber == 'Y' ? (data.@codeRequestCategory == 'QC' ? parentApplication.iconQC : (data.@codeRequestCategory == 'SOLEXA' ? parentApplication.iconSolexa : parentApplication.iconExperiment)) : '')}" >
		                    	 </mx:Image> 
		                           <mx:Label id="requestNumber" text="{data.@showRequestNumber == 'Y' ? data.@requestNumber : ''}">
		                           </mx:Label>
		                        </mx:HBox>
		                    </mx:Component>
		                </mx:itemRenderer>
		            </mx:DataGridColumn> 
		            <mx:DataGridColumn width="18" headerText="Folder" >
		                <mx:itemRenderer>
		                    <mx:Component >
		                        <mx:HBox  horizontalGap="0" >
		                          <mx:Image id="directoryImage" source="{data.@showDirectoryName == 'Y' ? parentApplication.iconFolder : ''}">
		                    	 </mx:Image> 
		                           <mx:Label id="directoryName" text="{data.@showDirectoryName == 'Y' ? data.@directoryName : ''}">
		                           </mx:Label>
		                        </mx:HBox>
		                    </mx:Component>
		                </mx:itemRenderer>
		            </mx:DataGridColumn> 
		              	<mx:DataGridColumn dataField="@displayName"    headerText="File"   width="70"/>
			    	<mx:DataGridColumn dataField="@type"           headerText="Type"   width="12"/>
			    	<mx:DataGridColumn dataField="@fileSizeText"   headerText="Size"   width="12"/>
			    	<mx:DataGridColumn dataField="@lastModifyDateDisplay" headerText="Date"   width="22"/>
			      </mx:columns>	
			    	
			    </mx:DataGrid>
			</mx:VBox>
			
	</mx:ViewStack>
		
	</mx:VBox>
	



</mx:Canvas>


